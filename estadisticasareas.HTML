<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Estad√≠sticas Acad√©micas por √Åreas - EduPage</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg-main:#F5F5F5;--bg-white:#FFFFFF;--border-gray:#E0E0E0;
      --blue-dark:#0D47A1;--blue-medium:#1976D2;--blue-light:#1565C0;
      --gray-dark:#424242;--gray-medium:#616161;--gray-light:#F5F5F5;
      --success:#4CAF50;--warning:#FF9800;--danger:#F44336;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg-main);color:var(--gray-dark);line-height:1.6}
    .header{background:linear-gradient(135deg,var(--blue-dark) 0%,var(--blue-medium) 100%);color:#fff;padding:20px 0;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .header-content{max-width:1400px;margin:0 auto;padding:0 20px}
    .header h1{font-size:28px;font-weight:300;letter-spacing:-.5px}
    .nav-tabs{background:#fff;border-bottom:1px solid var(--border-gray);position:sticky;top:0;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .nav-tabs-content{max-width:1400px;margin:0 auto;display:flex;overflow-x:auto;padding:0 20px;min-height:50px}
    .nav-tab{padding:16px 24px;background:none;border:none;color:var(--gray-medium);cursor:pointer;font-size:14px;font-weight:500;transition:.3s;border-bottom:3px solid transparent;display:flex;align-items:center;gap:8px;white-space:nowrap}
    .nav-tab:hover{color:var(--blue-medium);background:var(--gray-light)}
    .nav-tab.active{color:var(--blue-dark);border-bottom-color:var(--blue-medium);background:linear-gradient(to bottom,transparent,rgba(25,118,210,.05))}
    .container{max-width:1400px;margin:0 auto;padding:20px}
    .card{background:var(--bg-white);border:1px solid var(--border-gray);border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .card-header{border-bottom:2px solid var(--gray-light);padding-bottom:15px;margin-bottom:20px}
    .card-title{font-size:18px;color:var(--blue-dark);font-weight:600;display:flex;align-items:center;gap:10px}
    .card-subtitle{font-size:13px;color:var(--gray-medium);margin-top:5px}
    .grid{display:grid;gap:20px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:13px;font-weight:600;color:var(--gray-medium);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
    .form-control{width:100%;padding:10px 12px;border:1px solid var(--border-gray);border-radius:4px;font-size:14px;transition:.3s;background:#fff;color:var(--gray-dark)}
    .form-control:focus{outline:none;border-color:var(--blue-medium);box-shadow:0 0 0 3px rgba(25,118,210,.1)}
    .upload-area{border:2px dashed var(--border-gray);border-radius:8px;padding:30px;text-align:center;background:var(--gray-light);transition:.3s;cursor:pointer;position:relative}
    .upload-area:hover{border-color:var(--blue-medium);background:#fff}
    .upload-area.loaded{border-color:var(--success);background:#E8F5E9;border-style:solid}
    .upload-icon{font-size:48px;color:var(--blue-medium);margin-bottom:10px}
    .upload-text{font-size:14px;color:var(--gray-medium)}
    .upload-filename{font-size:13px;color:var(--success);margin-top:10px;font-weight:600}
    .file-input-hidden{position:absolute;width:100%;height:100%;top:0;left:0;opacity:0;cursor:pointer}
    .btn{padding:10px 20px;border:none;border-radius:4px;font-size:14px;font-weight:500;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(135deg,var(--blue-medium) 0%,var(--blue-light) 100%);color:#fff}
    .btn-primary:hover{box-shadow:0 4px 8px rgba(25,118,210,.3);transform:translateY(-1px)}
    .btn-secondary{background:var(--gray-light);color:var(--gray-dark);border:1px solid var(--border-gray)}
    .btn-secondary:hover{background:#fff;border-color:var(--gray-medium)}
    .btn-success{background:linear-gradient(135deg,var(--success) 0%,#45a049 100%);color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--danger) 0%,#da190b 100%);color:#fff}
    .btn-group{display:flex;gap:10px;flex-wrap:wrap}
    .areas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px;margin-top:20px}
    .area-item{background:var(--gray-light);padding:12px;border-radius:4px;display:flex;align-items:center;gap:10px;transition:.3s}
    .area-item:hover{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
    .loading.active{display:flex}
    .loading-spinner{width:50px;height:50px;border:4px solid #fff;border-top-color:var(--blue-medium);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .dashboard-section{display:none}
    .dashboard-section.active{display:block;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    table{width:100%;border-collapse:collapse}
    thead tr{background:linear-gradient(135deg,var(--blue-medium) 0%,var(--blue-light) 100%);color:#fff}
    th,td{border:1px solid var(--border-gray);padding:8px;font-size:13px}
    .tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px}
    .tag.ok{background:#E8F5E9;color:#1B5E20;border:1px solid #A5D6A7}
    .tag.warn{background:#FFF8E1;color:#EF6C00;border:1px solid #FFCC80}
    .tag.bad{background:#FFEBEE;color:#B71C1C;border:1px solid #EF9A9A}
    @media(max-width:768px){.container{padding:10px}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>üìä Estad√≠sticas Acad√©micas - √Åreas (Informe Acad√©mico por √Åreas - EduPage)</h1>
      <p>Sistema de an√°lisis y seguimiento del rendimiento estudiantil</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="nav-tabs">
    <div class="nav-tabs-content">
      <button class="nav-tab active" onclick="showDashboard('config', this)"><span>‚öôÔ∏è</span> Configuraci√≥n</button>
      <button class="nav-tab" onclick="showDashboard('general', this)"><span>üìà</span> Vista General</button>
      <button class="nav-tab" onclick="showDashboard('bajo', this)"><span>‚ö†Ô∏è</span> Estudiantes en BAJO</button>
      <button class="nav-tab" onclick="showDashboard('minimas', this)"><span>üìù</span> Notas M√≠nimas</button>
      <button class="nav-tab" onclick="showDashboard('area', this)"><span>üìö</span> Por √Årea</button>
      <button class="nav-tab" onclick="showDashboard('alertas', this)"><span>üîî</span> Tendencias y Alertas</button>
      <button class="nav-tab" onclick="showDashboard('perdida', this)"><span>‚ö†Ô∏è</span> P√©rdida del A√±o</button>
    </div>
  </div>

  <div class="container">
    <!-- Configuraci√≥n -->
    <div class="dashboard-section active" id="dashboard-config">
      <!-- Guardar/Cargar -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üíæ Gesti√≥n de An√°lisis</h2>
          <p class="card-subtitle">Guarde o recupere an√°lisis completos</p>
        </div>
        <div class="btn-group" style="justify-content:center">
          <button class="btn btn-success" onclick="saveAnalysis()">üíæ Guardar An√°lisis Actual</button>
          <label class="btn btn-primary" style="margin:0">
            üìÇ Cargar An√°lisis Guardado
            <input type="file" accept=".json" onchange="loadAnalysis(event)" style="display:none">
          </label>
        </div>
      </div>

      <!-- Colegio -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üè´ Informaci√≥n del Colegio</h2>
          <p class="card-subtitle">Configure la informaci√≥n institucional</p>
        </div>
        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Nombre del Colegio</label>
            <input type="text" class="form-control" id="nombreColegio" placeholder="Ingrese el nombre del colegio" onchange="updateColegioInfo()">
          </div>
          <div class="form-group">
            <label class="form-label">Logo/Escudo (archivo)</label>
            <input type="file" class="form-control" id="logoColegio" accept="image/*" onchange="handleLogoUpload(event)">
          </div>
          <div class="form-group">
            <label class="form-label">A√±o Lectivo</label>
            <input type="text" class="form-control" id="anoLectivo" value="2024" onchange="updateColegioInfo()">
          </div>
        </div>
        <div id="logoPreview" style="text-align:center;margin-top:20px;display:none">
          <img id="logoPreviewImg" alt="Logo del Colegio" style="max-height:100px">
        </div>
      </div>

      <!-- Periodos y Escala -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">‚öôÔ∏è Configuraci√≥n de Periodos</h2>
          <p class="card-subtitle">Define el peso porcentual de cada periodo acad√©mico</p>
        </div>

        <div class="grid grid-4">
          <div class="form-group">
            <label class="form-label">Periodo 1 (%)</label>
            <input type="number" class="form-control" id="peso1" value="25" min="0" max="100" oninput="updateTotalWeight()">
          </div>
          <div class="form-group">
            <label class="form-label">Periodo 2 (%)</label>
            <input type="number" class="form-control" id="peso2" value="25" min="0" max="100" oninput="updateTotalWeight()">
          </div>
          <div class="form-group">
            <label class="form-label">Periodo 3 (%)</label>
            <input type="number" class="form-control" id="peso3" value="25" min="0" max="100" oninput="updateTotalWeight()">
          </div>
          <div class="form-group">
            <label class="form-label">Periodo 4 (%)</label>
            <input type="number" class="form-control" id="peso4" value="25" min="0" max="100" oninput="updateTotalWeight()">
          </div>
        </div>

        <div style="text-align:center;padding:20px;background:var(--gray-light);border-radius:4px">
          <span id="totalPeso" style="font-size:24px;font-weight:600;color:var(--blue-dark)">Total: 100%</span>
        </div>

        <h3 style="margin-top:20px">Escala de Calificaci√≥n</h3>
        <div class="grid grid-4">
          <div class="form-group">
            <label class="form-label">Escala del Colegio</label>
            <select class="form-control" id="escalaCalificacion" onchange="updateNotaAprobacion()">
              <option value="5">1 a 5</option>
              <option value="10">1 a 10</option>
              <option value="50">1 a 50</option>
              <option value="100">1 a 100</option>
            </select>
          </div>

          <!-- CAMBIO: campo editable + onchange manual -->
          <div class="form-group">
            <label class="form-label">Nota M√≠nima de Aprobaci√≥n</label>
            <input type="number" class="form-control" id="notaAprobacion" value="3.0" step="0.1" onchange="updateNotaAprobacionManual()">
          </div>

          <div class="form-group">
            <label class="form-label">√Åreas para Perder el A√±o</label>
            <input type="number" class="form-control" id="areasPerderAno" value="3" min="1" max="10" onchange="escalaConfig.areasPerderAno=parseInt(this.value||3)">
          </div>
          <div class="form-group">
            <label class="form-label">Periodo Actual</label>
            <select class="form-control" id="periodoActual" onchange="escalaConfig.periodoActual=parseInt(this.value||1)">
              <option value="1">Periodo 1</option>
              <option value="2">Periodo 2</option>
              <option value="3" selected>Periodo 3</option>
              <option value="4">Periodo 4</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Archivos -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìÅ Carga de Archivos Excel</h2>
          <p class="card-subtitle">Seleccione los archivos de cada periodo acad√©mico</p>
        </div>

        <div class="grid grid-2">
          <div class="upload-area" id="upload1">
            <input type="file" class="file-input-hidden" id="file1" accept=".xlsx,.xls">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Periodo 1</div>
            <div class="upload-filename" id="filename1"></div>
          </div>
          <div class="upload-area" id="upload2">
            <input type="file" class="file-input-hidden" id="file2" accept=".xlsx,.xls">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Periodo 2</div>
            <div class="upload-filename" id="filename2"></div>
          </div>
          <div class="upload-area" id="upload3">
            <input type="file" class="file-input-hidden" id="file3" accept=".xlsx,.xls">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Periodo 3</div>
            <div class="upload-filename" id="filename3"></div>
          </div>
          <div class="upload-area" id="upload4">
            <input type="file" class="file-input-hidden" id="file4" accept=".xlsx,.xls">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Periodo 4</div>
            <div class="upload-filename" id="filename4"></div>
          </div>
        </div>

        <div class="btn-group" style="margin-top:20px;justify-content:center">
          <button class="btn btn-primary" onclick="processFiles()">üîç Procesar Archivos</button>
          <button class="btn btn-secondary" onclick="clearFiles()">üóëÔ∏è Limpiar Todo</button>
        </div>
      </div>

      <!-- √Åreas -->
      <div class="card" id="areasCard" style="display:none">
        <div class="card-header">
          <h2 class="card-title">üìö Selecci√≥n de √Åreas</h2>
          <p class="card-subtitle">Seleccione las √°reas que desea incluir en el an√°lisis</p>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="selectAllAreas()">‚úÖ Seleccionar Todas</button>
          <button class="btn btn-secondary" onclick="deselectAllAreas()">‚ùå Deseleccionar Todas</button>
        </div>
        <div class="areas-grid" id="areasGrid"></div>

        <div style="margin-top:20px;text-align:center">
          <button class="btn btn-success" onclick="generateStatistics()" style="font-size:16px;padding:12px 30px">üìä Generar Estad√≠sticas</button>
        </div>
      </div>
    </div>

    <!-- Vista General -->
    <div class="dashboard-section" id="dashboard-general">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-4" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGrado" onchange="applyFilters()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupo" onchange="applyFilters()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">√Årea</label><select class="form-control" id="filterArea" onchange="applyFilters()"><option value="">Todas</option></select></div>
          <div class="form-group"><label class="form-label">Estudiante</label><input type="text" class="form-control" id="filterEstudiante" placeholder="Buscar..." onkeyup="applyFilters()"></div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('general')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('general')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>Vista General</h2><div id="generalContent"><p>Las estad√≠sticas aparecer√°n aqu√≠ despu√©s de procesar los archivos.</p></div></div>
    </div>

    <!-- Estudiantes en BAJO -->
    <div class="dashboard-section" id="dashboard-bajo">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-4" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGradoBajo" onchange="updateEstudiantesBajo()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupoBajo" onchange="updateEstudiantesBajo()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">√Årea</label><select class="form-control" id="filterAreaBajo" onchange="updateEstudiantesBajo()"><option value="">Todas</option></select></div>
          <div class="form-group"><label class="form-label">Estudiante</label><input type="text" class="form-control" id="filterEstudianteBajo" placeholder="Buscar..." onkeyup="updateEstudiantesBajo()"></div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFiltersBajo()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('bajo')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('bajo')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>‚ö†Ô∏è Estudiantes con Desempe√±o BAJO</h2><div id="estudiantesBajoContent"><p>Procese los archivos para ver los estudiantes con desempe√±o bajo.</p></div></div>
    </div>

    <!-- Notas m√≠nimas -->
    <div class="dashboard-section" id="dashboard-minimas">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-4" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGradoMinimas" onchange="updateNotasMinimas()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupoMinimas" onchange="updateNotasMinimas()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">√Årea</label><select class="form-control" id="filterAreaMinimas" onchange="updateNotasMinimas()"><option value="">Todas</option></select></div>
          <div class="form-group"><label class="form-label">Estado</label>
            <select class="form-control" id="filterEstadoMinimas" onchange="updateNotasMinimas()">
              <option value="">Todos</option><option value="POSIBLE">Posible</option><option value="DIF√çCIL">Dif√≠cil</option>
              <option value="CR√çTICO">Cr√≠tico</option><option value="IMPOSIBLE">Imposible</option>
            </select>
          </div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFiltersMinimas()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('minimas')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('minimas')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>üìù Notas M√≠nimas Necesarias</h2><div id="notasMinimasContent"><p>Procese los archivos para ver las notas m√≠nimas necesarias.</p></div></div>
    </div>

    <!-- Por √Årea -->
    <div class="dashboard-section" id="dashboard-area">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-3" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGradoArea" onchange="updatePorArea()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupoArea" onchange="updatePorArea()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">√Årea</label><select class="form-control" id="filterAreaSelect" onchange="updatePorArea()"><option value="">Todas</option></select></div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFiltersArea()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('area')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('area')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>üìö An√°lisis por √Årea</h2><div id="AreaContent"><p>Procese los archivos para ver el an√°lisis por √Årea.</p></div></div>
    </div>

    <!-- Alertas -->
    <div class="dashboard-section" id="dashboard-alertas">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-4" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGradoAlertas" onchange="updateTendenciasAlertas()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupoAlertas" onchange="updateTendenciasAlertas()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Nivel de Riesgo</label>
            <select class="form-control" id="filterRiesgoAlertas" onchange="updateTendenciasAlertas()">
              <option value="">Todos</option><option value="ALTO">Alto</option><option value="MEDIO">Medio</option><option value="BAJO">Bajo</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Estudiante</label><input type="text" class="form-control" id="filterEstudianteAlertas" placeholder="Buscar..." onkeyup="updateTendenciasAlertas()"></div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFiltersAlertas()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('alertas')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('alertas')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>üîî Tendencias y Alertas Tempranas</h2><div id="alertasContent"><p>Procese los archivos para ver las tendencias y alertas.</p></div></div>
    </div>

    <!-- P√©rdida del A√±o -->
    <div class="dashboard-section" id="dashboard-perdida">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-bottom:15px">üîç Filtros</h3>
        <div class="grid grid-4" style="gap:10px">
          <div class="form-group"><label class="form-label">Grado</label><select class="form-control" id="filterGradoPerdida" onchange="updateAnalisisPerdida()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Grupo</label><select class="form-control" id="filterGrupoPerdida" onchange="updateAnalisisPerdida()"><option value="">Todos</option></select></div>
          <div class="form-group"><label class="form-label">Estado</label>
            <select class="form-control" id="filterEstadoPerdida" onchange="updateAnalisisPerdida()">
              <option value="">Todos</option>
              <option value="PERDIENDO">Perdiendo el A√±o</option>
              <option value="CRITICO">En Riesgo Cr√≠tico</option>
              <option value="DIFICIL">En Riesgo Dif√≠cil</option>
              <option value="POSIBLE">En Riesgo Posible</option>
              <option value="APROBANDO">Aprobando</option>
            </select>
          </div>
          <div class="form-group"><label class="form-label">Estudiante</label><input type="text" class="form-control" id="filterEstudiantePerdida" placeholder="Buscar..." onkeyup="updateAnalisisPerdida()"></div>
        </div>
        <div style="margin-top:10px;text-align:right">
          <button class="btn btn-secondary" onclick="clearFiltersPerdida()">üîÑ Limpiar Filtros</button>
          <button class="btn btn-danger" onclick="exportToPDF('perdida')">üìÑ Exportar PDF</button>
          <button class="btn btn-success" onclick="exportToExcel('perdida')">üìä Exportar Excel</button>
        </div>
      </div>
      <div class="card"><h2>‚ö†Ô∏è An√°lisis de P√©rdida del A√±o</h2><div id="perdidaContent"><p>Procese los archivos para ver el an√°lisis de p√©rdida del a√±o.</p></div></div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading"><div class="loading-spinner"></div></div>

  <script>
    // ====== Estado global ======
    let periodData = {1:null,2:null,3:null,4:null};
    let processedData = null;
    let availableAreas = [];
    let selectedAreas = [];
    let studentsData = [];
    let colegioInfo = {nombre:'',logo:'',anoLectivo:'2024'};

    let escalaConfig = {
      escala:5,
      notaMinima:3.0,          // <- editable por usuario
      periodoActual:3,
      areasPerderAno:3
    };

    // ====== Utilitarios UI ======
    function showLoading(show){document.getElementById('loading').classList.toggle('active', !!show)}
    function showDashboard(name, tab){
      document.querySelectorAll('.dashboard-section').forEach(s=>s.classList.remove('active'));
      document.getElementById('dashboard-'+name).classList.add('active');
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      if(tab) tab.classList.add('active');
    }

    // ====== Colegio / Config ======
    function updateColegioInfo(){
      colegioInfo.nombre = document.getElementById('nombreColegio').value || '';
      colegioInfo.anoLectivo = document.getElementById('anoLectivo').value || '2024';
    }
    function handleLogoUpload(e){
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{
        colegioInfo.logo = ev.target.result;
        const prev = document.getElementById('logoPreview');
        const img = document.getElementById('logoPreviewImg');
        img.src = colegioInfo.logo; prev.style.display='block';
      };
      r.readAsDataURL(f);
    }

    // ====== Escala / Nota Aprobaci√≥n ======
    function updateTotalWeight(){
      const p1=+document.getElementById('peso1').value||0;
      const p2=+document.getElementById('peso2').value||0;
      const p3=+document.getElementById('peso3').value||0;
      const p4=+document.getElementById('peso4').value||0;
      const total = p1+p2+p3+p4;
      const el = document.getElementById('totalPeso');
      el.textContent = `Total: ${total}%`;
      el.style.color = Math.abs(total-100)>0.01 ? '#F44336' : '#0D47A1';
    }

    function updateNotaAprobacion(){
      const escala = parseFloat(document.getElementById('escalaCalificacion').value);
      let sugerida;
      switch(escala){
        case 5: sugerida=3.0; break;
        case 10: sugerida=6.0; break;
        case 50: sugerida=30.0; break;
        case 100: sugerida=60.0; break;
        default: sugerida = escala*0.6;
      }
      // Proponemos valor, pero el usuario puede sobrescribirlo manualmente
      document.getElementById('notaAprobacion').value = sugerida;
      escalaConfig.escala = escala;
      escalaConfig.notaMinima = sugerida;
    }

    // CAMBIO CLAVE: permite fijar manualmente la nota m√≠nima
    function updateNotaAprobacionManual(){
      const input = document.getElementById('notaAprobacion');
      const nota = parseFloat(input.value);
      if(!isNaN(nota) && nota>0){
        escalaConfig.notaMinima = nota;
      }else{
        input.value = escalaConfig.notaMinima; // vuelve al √∫ltimo v√°lido
      }
    }

    // ====== Guardar / Cargar ======
    function saveAnalysis(){
      if(!processedData){alert('No hay datos para guardar. Procese los archivos primero.');return;}
      const analysisData = {
        version:'1.0',
        fecha:new Date().toISOString(),
        colegioInfo,
        escalaConfig,
        weights:{
          peso1:document.getElementById('peso1').value,
          peso2:document.getElementById('peso2').value,
          peso3:document.getElementById('peso3').value,
          peso4:document.getElementById('peso4').value
        },
        selectedAreas,
        studentsData,
        processedData:{
          totalStudents:processedData.totalStudents,
          averageScore:processedData.averageScore,
          performanceDistribution:processedData.performanceDistribution,
          notasMinimas:processedData.notasMinimas,
          analisisPerdida:processedData.analisisPerdida
        }
      };
      const dataStr = JSON.stringify(analysisData,null,2);
      const link = document.createElement('a');
      link.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(dataStr);
      const nombre = (colegioInfo.nombre||'colegio').replace(/\s/g,'_');
      link.download = `analisis_${nombre}_${Date.now()}.json`;
      link.click();
      alert('‚úÖ An√°lisis guardado exitosamente');
    }

    function loadAnalysis(e){
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{
        try{
          const data = JSON.parse(ev.target.result);
          if(!data.version){alert('Formato no v√°lido');return;}
          if(data.colegioInfo){
            colegioInfo = data.colegioInfo;
            document.getElementById('nombreColegio').value = colegioInfo.nombre||'';
            document.getElementById('anoLectivo').value = colegioInfo.anoLectivo||'2024';
            updateColegioInfo();
            if(colegioInfo.logo){
              document.getElementById('logoPreviewImg').src = colegioInfo.logo;
              document.getElementById('logoPreview').style.display='block';
            }
          }
          if(data.escalaConfig){
            escalaConfig = data.escalaConfig;
            document.getElementById('escalaCalificacion').value = escalaConfig.escala;
            document.getElementById('notaAprobacion').value = escalaConfig.notaMinima;
            document.getElementById('periodoActual').value = escalaConfig.periodoActual;
            document.getElementById('areasPerderAno').value = escalaConfig.areasPerderAno||3;
          }
          if(data.weights){
            document.getElementById('peso1').value = data.weights.peso1;
            document.getElementById('peso2').value = data.weights.peso2;
            document.getElementById('peso3').value = data.weights.peso3;
            document.getElementById('peso4').value = data.weights.peso4;
            updateTotalWeight();
          }
          selectedAreas = data.selectedAreas||[];
          availableAreas = [...selectedAreas];
          studentsData = data.studentsData||[];

          if(data.processedData){
            const w = {
              1:+data.weights.peso1/100,
              2:+data.weights.peso2/100,
              3:+data.weights.peso3/100,
              4:+data.weights.peso4/100
            };
            processedData = {
              ...data.processedData,
              students: studentsData,
              weights: w,
              estudiantesBajo: studentsData.filter(s=>s.performance==='BAJO'),
              estudiantesRiesgo: studentsData.filter(s=>s.failedAreas>=3),
              areasStats: {}
            };
            selectedAreas.forEach(a=>{
              processedData.areasStats[a]={scores:[],periodos:{1:[],2:[],3:[],4:[]},aprobados:0,reprobados:0}
            });
            studentsData.forEach(st=>{
              Object.entries(st.areas||{}).forEach(([areaName, areaData])=>{
                if(processedData.areasStats[areaName]){
                  processedData.areasStats[areaName].scores.push(areaData.final);
                  if(areaData.final>=escalaConfig.notaMinima) processedData.areasStats[areaName].aprobados++;
                  else processedData.areasStats[areaName].reprobados++;
                }
              });
            });
          }

          populateFilters();
          updateAllDashboards();
          showDashboard('general', document.querySelector('.nav-tab:nth-child(2)'));
          alert(`‚úÖ An√°lisis cargado exitosamente\n\nColegio: ${colegioInfo.nombre||'Sin nombre'}\nFecha: ${new Date(data.fecha).toLocaleDateString()}`);
        }catch(err){
          console.error(err);
          alert('Error al cargar el archivo. Verifique que sea un an√°lisis v√°lido.');
        }
      };
      r.readAsText(f);
    }

    // ====== Carga de Excel ======
    ['1','2','3','4'].forEach(p=>{
      document.getElementById('upload'+p).addEventListener('click',()=>document.getElementById('file'+p).click());
      document.getElementById('file'+p).addEventListener('change',e=>handleFileUpload(e, +p));
    });

    function handleFileUpload(event, periodo){
      const file = event.target.files?.[0]; if(!file) return;
      const filenameElement = document.getElementById('filename'+periodo);
      filenameElement.textContent='‚è≥ Procesando...'; filenameElement.style.color='#FF9800';
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
          const allSheets = [];
          wb.SheetNames.forEach(sheetName=>{
            const ws = wb.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
            const match = sheetName.match(/(\d+)-(\d+)/);
            const grado = match?match[1]:'N/A';
            const grupo = match?match[2]:'N/A';
            allSheets.push({sheet:sheetName,grado,grupo,data:json});
          });
          periodData[periodo]=allSheets;
          document.getElementById('upload'+periodo).classList.add('loaded');
          filenameElement.innerHTML = '<strong>‚úÖ '+file.name+'</strong>'; filenameElement.style.color='#4CAF50';
        }catch(err){
          console.error(err);
          filenameElement.innerHTML = '<strong>‚ùå Error al cargar</strong>'; filenameElement.style.color='#F44336';
          alert('Error al procesar el archivo: '+err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processFiles(){
      const hasFiles = Object.values(periodData).some(Boolean);
      if(!hasFiles){alert('Cargue al menos un archivo Excel.');return;}
      showLoading(true);
      setTimeout(()=>{
        try{
          extractAreas();
          document.getElementById('areasCard').style.display='block';
          showLoading(false);
        }catch(err){
          showLoading(false);
          alert('Error al procesar archivos: '+err.message);
        }
      },100);
    }

    function extractAreas(){
      const set = new Set();
      Object.values(periodData).forEach(data=>{
        if(!data) return;
        data.forEach(s=>{
          if(s.data && s.data[6]){
            const areaRow = s.data[6];
            for(let i=1;i<areaRow.length;i+=2){
              const area = String(areaRow[i]||'').trim();
              if(area && area.length>2){
                const exclude = ['Total','Promedio','Comportamiento','Asistencia','Puesto','Apoyo','Observaciones'];
                if(!exclude.some(t=>area.includes(t))) set.add(area);
              }
            }
          }
        });
      });
      availableAreas = Array.from(set).sort();
      const grid = document.getElementById('areasGrid');
      grid.innerHTML='';
      availableAreas.forEach((area,idx)=>{
        const div=document.createElement('div');
        div.className='area-item';
        div.innerHTML = `<input type="checkbox" id="area${idx}" value="${area}" checked><label for="area${idx}">${area}</label>`;
        grid.appendChild(div);
      });
      if(!availableAreas.length) alert('No se encontraron √°reas en los archivos.');
    }

    function clearFiles(){
      if(!confirm('¬øLimpiar todos los archivos?')) return;
      for(let i=1;i<=4;i++){
        periodData[i]=null;
        document.getElementById('file'+i).value='';
        document.getElementById('upload'+i).classList.remove('loaded');
        document.getElementById('filename'+i).textContent='';
      }
      document.getElementById('areasCard').style.display='none';
      processedData=null; availableAreas=[]; selectedAreas=[]; studentsData=[];
    }
    function selectAllAreas(){document.querySelectorAll('#areasGrid input[type="checkbox"]').forEach(cb=>cb.checked=true)}
    function deselectAllAreas(){document.querySelectorAll('#areasGrid input[type="checkbox"]').forEach(cb=>cb.checked=false)}

    // ====== Generar estad√≠sticas ======
    function generateStatistics(){
      const p1=+document.getElementById('peso1').value||0;
      const p2=+document.getElementById('peso2').value||0;
      const p3=+document.getElementById('peso3').value||0;
      const p4=+document.getElementById('peso4').value||0;
      if(Math.abs(p1+p2+p3+p4-100)>0.01){alert('Los porcentajes deben sumar 100%.');return;}
      selectedAreas = Array.from(document.querySelectorAll('#areasGrid input[type="checkbox"]:checked')).map(cb=>cb.value);
      if(!selectedAreas.length){alert('Seleccione al menos un √°rea.');return;}
      showLoading(true);
      setTimeout(()=>{
        try{
          processAllData();
          if(processedData && processedData.totalStudents>0){
            showDashboard('general', document.querySelector('.nav-tab:nth-child(2)'));
            alert(`‚úÖ Estad√≠sticas generadas\nTotal estudiantes: ${processedData.totalStudents}\nPromedio general: ${processedData.averageScore}`);
          }else{
            alert('‚ö†Ô∏è No se pudieron generar las estad√≠sticas. Verifique los datos.');
          }
          showLoading(false);
        }catch(err){
          showLoading(false);
          alert('Error al generar estad√≠sticas: '+err.message);
        }
      },120);
    }

    function processAllData(){
      const weights = {
        1:(+document.getElementById('peso1').value)/100,
        2:(+document.getElementById('peso2').value)/100,
        3:(+document.getElementById('peso3').value)/100,
        4:(+document.getElementById('peso4').value)/100
      };
      studentsData = [];
      const areasStats = {};
      selectedAreas.forEach(a=>areasStats[a]={scores:[],periodos:{1:[],2:[],3:[],4:[]},aprobados:0,reprobados:0});

      // Procesar periodos
      Object.entries(periodData).forEach(([periodo,data])=>{
        if(!data) return;
        data.forEach(sheet=>processSheetData(sheet, +periodo, weights[periodo], areasStats));
      });

      calculateFinalScores(weights);
      calculateMinimumGrades(weights);
      generatePredictions();
      const analisisPerdida = calculateAnalisisPerdida();
      const notasMinimas = calculateNotasMinimas();

      processedData = {
        totalStudents: studentsData.length,
        averageScore: calculateAverage(studentsData.map(s=>s.finalScore)),
        areasStats,
        performanceDistribution: calculatePerformanceDistribution(),
        students: studentsData,
        weights,
        estudiantesBajo: studentsData.filter(s=>s.performance==='BAJO'),
        estudiantesRiesgo: studentsData.filter(s=>s.failedAreas>=escalaConfig.areasPerderAno),
        notasMinimas,
        analisisPerdida
      };

      populateFilters();
      updateAllDashboards();
    }

    function processSheetData(sheetData, periodo, weight, areasStats){
      const data = sheetData.data;
      if(!data || data.length<8) return;
      const areaRow = data[6];
      const areaColumns = [];
      selectedAreas.forEach(area=>{
        for(let i=1;i<areaRow.length;i+=2){
          if(String(areaRow[i]||'').trim()===area){
            areaColumns.push({area,calIndex:i,jvIndex:i+1}); break;
          }
        }
      });

      for(let row=7; row<data.length; row++){
        const r = data[row]; if(!r || !r[0]) continue;
        const studentName = String(r[0]).trim(); if(!studentName) continue;

        let student = studentsData.find(s=>s.name===studentName && s.grado===sheetData.grado && s.grupo===sheetData.grupo);
        if(!student){
          student = {name:studentName, grado:sheetData.grado, grupo:sheetData.grupo, areas:{}, periodos:{}, finalScore:0, acumulado:0, performance:'', failedAreas:0, notasMinimas:{}, predictions:{}};
          studentsData.push(student);
        }
        if(!student.periodos[periodo]) student.periodos[periodo]={promedio:0,areas:{}};

        areaColumns.forEach(col=>{
          const cal = parseFloat(r[col.calIndex])||0;
          const jv = r[col.jvIndex] || getDesempeno(cal);
          if(!student.areas[col.area]) student.areas[col.area]={periodos:{},final:0,jvFinal:'',notaMinima:0,estadoAprobacion:'',acumulado:0,pesoAcumulado:0,pesoRestante:0};
          student.areas[col.area].periodos[periodo]={cal,jv,weight};
          areasStats[col.area].scores.push(cal);
          areasStats[col.area].periodos[periodo].push({student:studentName,score:cal,jv});
        });
      }
    }

    function calculateFinalScores(weights){
      studentsData.forEach(st=>{
        let totalScore=0, totalAreas=0; st.failedAreas=0;
        Object.entries(st.areas).forEach(([areaName, areaData])=>{
          let areaTotal=0, areaWeight=0;
          Object.values(areaData.periodos).forEach(p=>{areaTotal+=p.cal*p.weight; areaWeight+=p.weight;});
          areaData.final = areaWeight>0 ? areaTotal/areaWeight : 0;
          areaData.jvFinal = getDesempeno(areaData.final);
          if(areaData.final < escalaConfig.notaMinima) st.failedAreas++;
          totalScore += areaData.final; totalAreas++;
        });
        st.finalScore = totalAreas>0 ? totalScore/totalAreas : 0;
        st.acumulado = st.finalScore;
        st.performance = getDesempeno(st.finalScore);
      });
    }

    function calculateMinimumGrades(weights){
      const periodoActual = parseInt(document.getElementById('periodoActual').value)||1;
      studentsData.forEach(st=>{
        Object.entries(st.areas).forEach(([areaName,areaData])=>{
          let acumulado=0, pesoAcumulado=0;
          for(let p=1;p<=periodoActual;p++){
            if(areaData.periodos[p]){acumulado+=areaData.periodos[p].cal*weights[p]; pesoAcumulado+=weights[p];}
          }
          let pesoRestante=0; for(let p=periodoActual+1;p<=4;p++){pesoRestante+=weights[p];}

          const notaNecesaria = pesoRestante>0 ? (escalaConfig.notaMinima - acumulado)/pesoRestante : 0;
          areaData.notaMinima = notaNecesaria;
          areaData.acumulado = acumulado;
          areaData.pesoAcumulado = pesoAcumulado*100;
          areaData.pesoRestante = pesoRestante*100;

          if(notaNecesaria<=0) areaData.estadoAprobacion='APROBADO';
          else if(notaNecesaria<=escalaConfig.notaMinima) areaData.estadoAprobacion='POSIBLE';
          else if(notaNecesaria<=escalaConfig.escala*0.8) areaData.estadoAprobacion='DIF√çCIL';
          else if(notaNecesaria<=escalaConfig.escala) areaData.estadoAprobacion='CR√çTICO';
          else areaData.estadoAprobacion='IMPOSIBLE';
        });
      });
    }

    function calculateNotasMinimas(){
      const out=[];
      studentsData.forEach(st=>{
        Object.entries(st.areas).forEach(([areaName,a])=>{
          if(a.final<escalaConfig.notaMinima || a.estadoAprobacion!=='APROBADO'){
            out.push({
              estudiante:st.name, grado:st.grado, grupo:st.grupo, area:areaName,
              acumulado: +(a.acumulado||a.final).toFixed(2),
              pesoAcumulado: +(a.pesoAcumulado||0).toFixed(0),
              pesoRestante: +(a.pesoRestante||0).toFixed(0),
              notaMinima: +((a.notaMinima||0)).toFixed(2),
              estado:a.estadoAprobacion
            });
          }
        });
      });
      return out;
    }

    function generatePredictions(){
      studentsData.forEach(st=>{
        const scores=[];
        for(let p=1;p<=4;p++){
          let s=0,c=0;
          Object.values(st.areas).forEach(a=>{if(a.periodos[p]){s+=a.periodos[p].cal;c++;}});
          if(c>0) scores.push(s/c);
        }
        const trend = calculateTrend(scores);
        let prob=0, nm=escalaConfig.notaMinima;
        if(st.finalScore < nm*0.5) prob+=40; else if(st.finalScore < nm*0.75) prob+=30; else if(st.finalScore < nm) prob+=20; else if(st.finalScore < nm*1.2) prob+=10;
        if(st.failedAreas>=escalaConfig.areasPerderAno) prob+=30; else if(st.failedAreas>=2) prob+=20; else if(st.failedAreas>=1) prob+=10;
        if(trend<-0.5) prob+=20; else if(trend<0) prob+=10;
        const areasImpos = Object.values(st.areas).filter(a=>a.estadoAprobacion==='IMPOSIBLE').length;
        const areasCrit = Object.values(st.areas).filter(a=>a.estadoAprobacion==='CR√çTICO').length;
        prob += areasImpos*15 + areasCrit*8;
        st.predictions = {probability:Math.min(prob,100),trend,risk: prob>70?'ALTO':prob>40?'MEDIO':'BAJO',tendencia: trend>0.1?'MEJORANDO':trend<-0.1?'EMPEORANDO':'ESTABLE'};
      });
    }

    function calculateTrend(scores){
      if(scores.length<2) return 0;
      let sumX=0,sumY=0,sumXY=0,sumX2=0,n=scores.length;
      for(let i=0;i<n;i++){sumX+=i;sumY+=scores[i];sumXY+=i*scores[i];sumX2+=i*i;}
      const slope=(n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
      return slope;
    }

    function getDesempeno(score){
      const e=escalaConfig.escala, nm=escalaConfig.notaMinima;
      if(score>=e*0.92) return 'SUPERIOR';
      if(score>=e*0.8) return 'ALTO';
      if(score>=nm) return 'B√ÅSICO';
      return 'BAJO';
    }
    function calculateAverage(arr){if(!arr.length) return 0; const s=arr.reduce((a,b)=>a+b,0); return +(s/arr.length).toFixed(2)}
    function calculatePerformanceDistribution(){
      const d={SUPERIOR:0,ALTO:0,B√ÅSICO:0,BAJO:0};
      studentsData.forEach(s=>{d[s.performance]++}); return d;
    }

    function calculateAnalisisPerdida(){
      const nm=escalaConfig.notaMinima;
      const perdiendo=[], critico=[], dificil=[], posible=[], aprobando=[];
      studentsData.forEach(st=>{
        if(st.finalScore<nm && st.failedAreas>=escalaConfig.areasPerderAno) perdiendo.push(st);
        else if(st.predictions.risk==='ALTO') critico.push(st);
        else if(st.predictions.risk==='MEDIO') dificil.push(st);
        else if(st.predictions.risk==='BAJO' && st.finalScore<nm) posible.push(st);
        else aprobando.push(st);
      });
      return {perdiendo,critico,dificil,posible,aprobando};
    }

    // ====== Filtros y render ======
    function populateFilters(){
      const grados = new Set(), grupos = new Set(), areas = new Set();
      studentsData.forEach(s=>{grados.add(s.grado);grupos.add(s.grupo);Object.keys(s.areas).forEach(a=>areas.add(a));});
      function fill(id, set, allLabel){const sel=document.getElementById(id); sel.innerHTML=''; const o=document.createElement('option');o.value='';o.textContent=allLabel; sel.appendChild(o); Array.from(set).sort().forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;sel.appendChild(op);});}
      fill('filterGrado',''||grados,'Todos'); fill('filterGrupo',''||grupos,'Todos'); fill('filterArea',''||areas,'Todas');
      fill('filterGradoBajo',grados,'Todos'); fill('filterGrupoBajo',grupos,'Todos'); fill('filterAreaBajo',areas,'Todas');
      fill('filterGradoMinimas',grados,'Todos'); fill('filterGrupoMinimas',grupos,'Todos'); fill('filterAreaMinimas',areas,'Todas');
      fill('filterGradoArea',grados,'Todos'); fill('filterGrupoArea',grupos,'Todos'); fill('filterAreaSelect',areas,'Todas');
      fill('filterGradoAlertas',grados,'Todos'); fill('filterGrupoAlertas',grupos,'Todos');
      fill('filterGradoPerdida',grados,'Todos'); fill('filterGrupoPerdida',grupos,'Todos');
    }

    function applyFilters(){
      updateGeneralDashboard();
    }
    function clearFilters(){
      ['filterGrado','filterGrupo','filterArea'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('filterEstudiante').value='';
      applyFilters();
    }
    function clearFiltersBajo(){
      ['filterGradoBajo','filterGrupoBajo','filterAreaBajo'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('filterEstudianteBajo').value=''; updateEstudiantesBajo();
    }
    function clearFiltersMinimas(){
      ['filterGradoMinimas','filterGrupoMinimas','filterAreaMinimas','filterEstadoMinimas'].forEach(id=>document.getElementById(id).value='');
      updateNotasMinimas();
    }
    function clearFiltersArea(){
      ['filterGradoArea','filterGrupoArea','filterAreaSelect'].forEach(id=>document.getElementById(id).value='');
      updatePorArea();
    }
    function clearFiltersAlertas(){
      ['filterGradoAlertas','filterGrupoAlertas','filterRiesgoAlertas'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('filterEstudianteAlertas').value=''; updateTendenciasAlertas();
    }
    function clearFiltersPerdida(){
      ['filterGradoPerdida','filterGrupoPerdida','filterEstadoPerdida'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('filterEstudiantePerdida').value=''; updateAnalisisPerdida();
    }

    function updateAllDashboards(){
      updateGeneralDashboard();
      updateEstudiantesBajo();
      updateNotasMinimas();
      updatePorArea();
      updateTendenciasAlertas();
      updateAnalisisPerdida();
    }

    function updateGeneralDashboard(){
      const grado=document.getElementById('filterGrado').value;
      const grupo=document.getElementById('filterGrupo').value;
      const areaSel=document.getElementById('filterArea').value;
      const q=(document.getElementById('filterEstudiante').value||'').toLowerCase();

      const rows=[];
      studentsData.forEach(st=>{
        if(grado && st.grado!==grado) return;
        if(grupo && st.grupo!==grupo) return;
        if(q && !st.name.toLowerCase().includes(q)) return;
        const areas = areaSel ? {[areaSel]:st.areas[areaSel]} : st.areas;
        Object.entries(areas).forEach(([a,ad])=>{
          if(!ad) return;
          rows.push({
            Estudiante:st.name, Grado:st.grado, Grupo:st.grupo,
            √Årea:a, Final:+ad.final.toFixed(2), Desempe√±o:ad.jvFinal,
            '¬øBajo?': ad.final<escalaConfig.notaMinima?'S√≠':'No'
          });
        });
      });

      const el = document.getElementById('generalContent');
      if(!rows.length){el.innerHTML='<p>No hay datos para mostrar con los filtros actuales.</p>'; return;}
      el.innerHTML = buildTable(rows);
    }

    function updateEstudiantesBajo(){
      const grado=document.getElementById('filterGradoBajo').value;
      const grupo=document.getElementById('filterGrupoBajo').value;
      const areaSel=document.getElementById('filterAreaBajo').value;
      const q=(document.getElementById('filterEstudianteBajo').value||'').toLowerCase();

      const rows=[];
      studentsData.forEach(st=>{
        if(grado && st.grado!==grado) return;
        if(grupo && st.grupo!==grupo) return;
        if(q && !st.name.toLowerCase().includes(q)) return;
        Object.entries(st.areas).forEach(([a,ad])=>{
          if(areaSel && a!==areaSel) return;
          if(ad.final < escalaConfig.notaMinima){
            rows.push({
              Estudiante:st.name, Grado:st.grado, Grupo:st.grupo,
              √Årea:a, Final:+ad.final.toFixed(2),
              Estado:`BAJO (${ad.jvFinal})`
            });
          }
        });
      });
      const el=document.getElementById('estudiantesBajoContent');
      el.innerHTML = rows.length? buildTable(rows) : '<p>Sin estudiantes en BAJO seg√∫n filtros.</p>';
    }

    function updateNotasMinimas(){
      if(!processedData){document.getElementById('notasMinimasContent').innerHTML='<p>Procese los archivos para ver las notas m√≠nimas necesarias.</p>';return;}
      const grado=document.getElementById('filterGradoMinimas').value;
      const grupo=document.getElementById('filterGrupoMinimas').value;
      const areaSel=document.getElementById('filterAreaMinimas').value;
      const estado=document.getElementById('filterEstadoMinimas').value;

      const rows = processedData.notasMinimas.filter(r=>{
        if(grado && r.grado!==grado) return false;
        if(grupo && r.grupo!==grupo) return false;
        if(areaSel && r.area!==areaSel) return false;
        if(estado && r.estado!==estado) return false;
        return true;
      }).map(r=>({
        Estudiante:r.estudiante, Grado:r.grado, Grupo:r.grupo, √Årea:r.area,
        Acumulado:+r.acumulado.toFixed(2), 'Peso acum. (%)':r.pesoAcumulado, 'Peso rest. (%)':r.pesoRestante,
        'Nota necesaria': +(r.notaMinima).toFixed(2),
        Estado:r.estado
      }));

      const el=document.getElementById('notasMinimasContent');
      el.innerHTML = rows.length? buildTable(rows) : '<p>No hay registros con los filtros actuales.</p>';
    }

    function updatePorArea(){
      const grado=document.getElementById('filterGradoArea').value;
      const grupo=document.getElementById('filterGrupoArea').value;
      const areaSel=document.getElementById('filterAreaSelect').value;

      const rows=[];
      studentsData.forEach(st=>{
        if(grado && st.grado!==grado) return;
        if(grupo && st.grupo!==grupo) return;
        Object.entries(st.areas).forEach(([a,ad])=>{
          if(areaSel && a!==areaSel) return;
          rows.push({√Årea:a, Estudiante:st.name, Grado:st.grado, Grupo:st.grupo, Final:+ad.final.toFixed(2), Desempe√±o:ad.jvFinal});
        });
      });
      const el=document.getElementById('AreaContent');
      el.innerHTML = rows.length? buildTable(rows) : '<p>No hay datos para mostrar con los filtros actuales.</p>';
    }

    function updateTendenciasAlertas(){
      const grado=document.getElementById('filterGradoAlertas').value;
      const grupo=document.getElementById('filterGrupoAlertas').value;
      const riesgo=document.getElementById('filterRiesgoAlertas').value;
      const q=(document.getElementById('filterEstudianteAlertas').value||'').toLowerCase();

      const rows=[];
      studentsData.forEach(st=>{
        if(grado && st.grado!==grado) return;
        if(grupo && st.grupo!==grupo) return;
        if(q && !st.name.toLowerCase().includes(q)) return;
        if(riesgo && st.predictions.risk!==riesgo) return;
        rows.push({
          Estudiante:st.name, Grado:st.grado, Grupo:st.grupo,
          Promedio:+st.finalScore.toFixed(2),
          Riesgo:st.predictions.risk,
          Probabilidad:(+st.predictions.probability.toFixed(0))+'%',
          Tendencia:st.predictions.tendencia
        });
      });

      const el=document.getElementById('alertasContent');
      el.innerHTML = rows.length? buildTable(rows) : '<p>Sin alertas con los filtros actuales.</p>';
    }

    function updateAnalisisPerdida(){
      if(!processedData){document.getElementById('perdidaContent').innerHTML='<p>Procese los archivos para ver el an√°lisis de p√©rdida del a√±o.</p>';return;}
      const grado=document.getElementById('filterGradoPerdida').value;
      const grupo=document.getElementById('filterGrupoPerdida').value;
      const estado=document.getElementById('filterEstadoPerdida').value;
      const q=(document.getElementById('filterEstudiantePerdida').value||'').toLowerCase();

      const list = [];
      function pushList(arr, etiqueta){
        arr.forEach(st=>{
          if(grado && st.grado!==grado) return;
          if(grupo && st.grupo!==grupo) return;
          if(q && !st.name.toLowerCase().includes(q)) return;
          list.push({Estado:etiqueta, Estudiante:st.name, Grado:st.grado, Grupo:st.grupo, Promedio:+st.finalScore.toFixed(2), √Åreas_Bajo:st.failedAreas});
        });
      }
      if(!estado || estado==='PERDIENDO') pushList(processedData.analisisPerdida.perdiendo,'PERDIENDO');
      if(!estado || estado==='CRITICO') pushList(processedData.analisisPerdida.critico,'CRITICO');
      if(!estado || estado==='DIFICIL') pushList(processedData.analisisPerdida.dificil,'DIFICIL');
      if(!estado || estado==='POSIBLE') pushList(processedData.analisisPerdida.posible,'POSIBLE');
      if(!estado || estado==='APROBANDO') pushList(processedData.analisisPerdida.aprobando,'APROBANDO');

      const el=document.getElementById('perdidaContent');
      el.innerHTML = list.length? buildTable(list) : '<p>No hay registros con los filtros actuales.</p>';
    }

    // ====== Exportar ======
    function exportToPDF(section){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l','pt','a4');
      const map = {
        general:'generalContent',
        bajo:'estudiantesBajoContent',
        minimas:'notasMinimasContent',
        area:'AreaContent',
        alertas:'alertasContent',
        perdida:'perdidaContent'
      };
      const el = document.getElementById(map[section]||'generalContent');
      if(!el){alert('Nada para exportar.');return;}
      doc.setFontSize(14); doc.text('Reporte - '+section.toUpperCase(), 40, 40);
      const table = el.querySelector('table');
      if(!table){doc.text('Sin datos', 40, 70); doc.save('reporte_'+section+'.pdf'); return;}
      const head=[], body=[];
      const ths = table.querySelectorAll('thead th');
      const tds = table.querySelectorAll('tbody tr');
      head.push(Array.from(ths).map(th=>th.innerText));
      tds.forEach(tr=>{
        const cols=Array.from(tr.querySelectorAll('td')).map(td=>td.innerText);
        body.push(cols);
      });
      doc.autoTable({head, body, startY:60, styles:{fontSize:9}});
      doc.save('reporte_'+section+'.pdf');
    }

    function exportToExcel(section){
      const map = {
        general:'generalContent',
        bajo:'estudiantesBajoContent',
        minimas:'notasMinimasContent',
        area:'AreaContent',
        alertas:'alertasContent',
        perdida:'perdidaContent'
      };
      const el = document.getElementById(map[section]||'generalContent');
      const table = el.querySelector('table');
      if(!table){alert('Nada para exportar.');return;}
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
      XLSX.writeFile(wb, `reporte_${section}.xlsx`);
    }

    // ====== Helpers ======
    function buildTable(rows){
      if(!rows.length) return '<p>Sin datos.</p>';
      const cols = Object.keys(rows[0]);
      let html = '<div style="overflow:auto"><table><thead><tr>';
      cols.forEach(c=>html+=`<th>${c}</th>`); html+='</tr></thead><tbody>';
      rows.forEach(r=>{
        html+='<tr>';
        cols.forEach(c=>{
          const v=r[c];
          let cell = v;
          html+=`<td>${cell}</td>`;
        });
        html+='</tr>';
      });
      html+='</tbody></table></div>';
      return html;
    }

    // Init
    updateTotalWeight();
  </script>
</body>
</html>
