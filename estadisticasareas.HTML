<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estad√≠sticas Acad√©micas por Areas - Edupage</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #F5F5F5;
            --bg-white: #FFFFFF;
            --border-gray: #E0E0E0;
            --blue-dark: #0D47A1;
            --blue-medium: #1976D2;
            --blue-light: #1565C0;
            --gray-dark: #424242;
            --gray-medium: #616161;
            --gray-light: #F5F5F5;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-main);
            color: var(--gray-dark);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-medium) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: -0.5px;
            color: white;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
            color: white;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--border-gray);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-tabs-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
            padding: 0 20px;
            min-height: 50px;
        }

        .nav-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            color: var(--gray-medium);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: var(--blue-medium);
            background: var(--gray-light);
        }

        .nav-tab.active {
            color: var(--blue-dark);
            border-bottom-color: var(--blue-medium);
            background: linear-gradient(to bottom, transparent, rgba(25, 118, 210, 0.05));
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cards */
        .card {
            background: var(--bg-white);
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            color: var(--gray-dark);
        }

        .card-header {
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            color: var(--blue-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--gray-medium);
            margin-top: 5px;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-medium);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
            color: var(--gray-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--blue-medium);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-gray);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: var(--gray-light);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--blue-medium);
            background: white;
        }

        .upload-area.loaded {
            border-color: var(--success);
            background: #E8F5E9;
            border-style: solid;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--blue-medium);
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: var(--gray-medium);
        }

        .upload-filename {
            font-size: 13px;
            color: var(--success);
            margin-top: 10px;
            font-weight: 600;
        }

        .file-input-hidden {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue-medium) 0%, var(--blue-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--gray-dark);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--gray-medium);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #da190b 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Areas Selection */
        .areas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .area-item {
            background: var(--gray-light);
            padding: 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .area-item:hover {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .area-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .area-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: var(--gray-dark);
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid white;
            border-top-color: var(--blue-medium);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dashboard Sections */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Asegurar texto visible */
        h2, h3, h4, h5, h6 {
            color: var(--gray-dark);
        }

        p, div, span, td, th, label {
            color: inherit;
        }

        table {
            color: var(--gray-dark);
        }

        table thead tr {
            background: linear-gradient(135deg, var(--blue-medium) 0%, var(--blue-light) 100%);
        }

        table thead tr th {
            color: white;
        }

        table tbody td {
            color: var(--gray-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs-content {
                overflow-x: scroll;
            }
        }

        button {
            font-family: inherit;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>üìä Estad√≠sticas Acad√©micas - Areas (informe Acad√©mico por Areas (Edupage) </h1>
            <p>Sistema de an√°lisis y seguimiento del rendimiento estudiantil</p>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <div class="nav-tabs-content">
            <button class="nav-tab active" onclick="showDashboard('config', this)">
                <span class="icon">‚öôÔ∏è</span>
                <span>Configuraci√≥n</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('general', this)">
                <span class="icon">üìà</span>
                <span>Vista General</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('bajo', this)">
                <span class="icon">‚ö†Ô∏è</span>
                <span>Estudiantes en BAJO</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('minimas', this)">
                <span class="icon">üìù</span>
                <span>Notas M√≠nimas</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('area', this)">
                <span class="icon">üìö</span>
                <span>Por Area</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('alertas', this)">
                <span class="icon">üîî</span>
                <span>Tendencias y Alertas</span>
            </button>
            <button class="nav-tab" onclick="showDashboard('perdida', this)">
                <span class="icon">‚ö†Ô∏è</span>
                <span>An√°lisis P√©rdida del A√±o</span>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Dashboard: Configuraci√≥n -->
        <div class="dashboard-section active" id="dashboard-config">
            <!-- Botones de Guardar y Cargar An√°lisis -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üíæ</span>
                        Gesti√≥n de An√°lisis
                    </h2>
                    <p class="card-subtitle">Guarde o recupere an√°lisis completos</p>
                </div>
                
                <div class="btn-group" style="justify-content: center;">
                    <button class="btn btn-success" onclick="saveAnalysis()">
                        <span>üíæ</span>
                        Guardar An√°lisis Actual
                    </button>
                    <label class="btn btn-primary" style="margin: 0;">
                        <span>üìÇ</span>
                        Cargar An√°lisis Guardado
                        <input type="file" accept=".json" onchange="loadAnalysis(event)" style="display: none;">
                    </label>
                </div>
            </div>

            <!-- Informaci√≥n del Colegio -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üè´</span>
                        Informaci√≥n del Colegio
                    </h2>
                    <p class="card-subtitle">Configure la informaci√≥n institucional</p>
                </div>
                
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Nombre del Colegio</label>
                        <input type="text" class="form-control" id="nombreColegio" placeholder="Ingrese el nombre del colegio" onchange="updateColegioInfo()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Logo/Escudo (URL o archivo)</label>
                        <input type="file" class="form-control" id="logoColegio" accept="image/*" onchange="handleLogoUpload(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">A√±o Lectivo</label>
                        <input type="text" class="form-control" id="anoLectivo" value="2024" onchange="updateColegioInfo()">
                    </div>
                </div>
                
                <div id="logoPreview" style="text-align: center; margin-top: 20px; display: none;">
                    <img id="logoPreviewImg" src="" alt="Logo del Colegio" style="max-height: 100px;">
                </div>
            </div>
            
            <!-- Configuraci√≥n de Pesos -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>‚öôÔ∏è</span>
                        Configuraci√≥n de Periodos
                    </h2>
                    <p class="card-subtitle">Define el peso porcentual de cada periodo acad√©mico</p>
                </div>
                
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Periodo 1 (%)</label>
                        <input type="number" class="form-control" id="peso1" value="25" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Periodo 2 (%)</label>
                        <input type="number" class="form-control" id="peso2" value="25" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Periodo 3 (%)</label>
                        <input type="number" class="form-control" id="peso3" value="25" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Periodo 4 (%)</label>
                        <input type="number" class="form-control" id="peso4" value="25" min="0" max="100">
                    </div>
                </div>
                
                <div style="text-align: center; padding: 20px; background: var(--gray-light); border-radius: 4px;">
                    <span style="font-size: 24px; font-weight: 600; color: var(--blue-dark);" id="totalPeso">Total: 100%</span>
                </div>
                
                <h3 style="margin-top: 20px;">Escala de Calificaci√≥n</h3>
                <div class="grid grid-4">
                    <div class="form-group">
                        <label class="form-label">Escala del Colegio</label>
                        <select class="form-control" id="escalaCalificacion" onchange="updateNotaAprobacion()">
                            <option value="5">1 a 5</option>
                            <option value="10">1 a 10</option>
                            <option value="50">1 a 50</option>
                            <option value="100">1 a 100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nota M√≠nima de Aprobaci√≥n</label>
                        <input type="number" class="form-control" id="notaAprobacion" value="3.0" step="0.1" min="0" onchange="updateNotaAprobacionManual()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">√Åreas para Perder el A√±o</label>
                        <input type="number" class="form-control" id="areasPerderAno" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Periodo Actual</label>
                        <select class="form-control" id="periodoActual">
                            <option value="1">Periodo 1</option>
                            <option value="2">Periodo 2</option>
                            <option value="3">Periodo 3</option>
                            <option value="4">Periodo 4</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Carga de Archivos -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üìÅ</span>
                        Carga de Archivos Excel
                    </h2>
                    <p class="card-subtitle">Selecciona los archivos de cada periodo acad√©mico</p>
                </div>
                
                <div class="grid grid-2">
                    <div class="upload-area" id="upload1">
                        <input type="file" class="file-input-hidden" id="file1" accept=".xlsx,.xls">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Periodo 1</div>
                        <div class="upload-filename" id="filename1"></div>
                    </div>
                    
                    <div class="upload-area" id="upload2">
                        <input type="file" class="file-input-hidden" id="file2" accept=".xlsx,.xls">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Periodo 2</div>
                        <div class="upload-filename" id="filename2"></div>
                    </div>
                    
                    <div class="upload-area" id="upload3">
                        <input type="file" class="file-input-hidden" id="file3" accept=".xlsx,.xls">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Periodo 3</div>
                        <div class="upload-filename" id="filename3"></div>
                    </div>
                    
                    <div class="upload-area" id="upload4">
                        <input type="file" class="file-input-hidden" id="file4" accept=".xlsx,.xls">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Periodo 4</div>
                        <div class="upload-filename" id="filename4"></div>
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                    <button class="btn btn-primary" onclick="processFiles()">
                        <span>üîç</span>
                        Procesar Archivos
                    </button>
                    <button class="btn btn-secondary" onclick="clearFiles()">
                        <span>üóëÔ∏è</span>
                        Limpiar Todo
                    </button>
                </div>
            </div>

            <!-- Selecci√≥n de √Åreas -->
            <div class="card" id="areasCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üìö</span>
                        Selecci√≥n de √Åreas
                    </h2>
                    <p class="card-subtitle">Selecciona las √°reas que deseas incluir en el an√°lisis</p>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="selectAllAreas()">
                        <span>‚úÖ</span>
                        Seleccionar Todas
                    </button>
                    <button class="btn btn-secondary" onclick="deselectAllAreas()">
                        <span>‚ùå</span>
                        Deseleccionar Todas
                    </button>
                </div>
                
                <div class="areas-grid" id="areasGrid"></div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="generateStatistics()" style="font-size: 16px; padding: 12px 30px;">
                        <span>üìä</span>
                        Generar Estad√≠sticas
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard: Vista General -->
        <div class="dashboard-section" id="dashboard-general">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-4" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control filter-control" id="filterGrado" onchange="applyFilters()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control filter-control" id="filterGrupo" onchange="applyFilters()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-control filter-control" id="filterArea" onchange="applyFilters()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estudiante</label>
                        <input type="text" class="form-control filter-control" id="filterEstudiante" placeholder="Buscar..." onkeyup="applyFilters()">
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('general')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('general')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Vista General</h2>
                <div id="generalContent">
                    <p>Las estad√≠sticas aparecer√°n aqu√≠ despu√©s de procesar los archivos.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard: Estudiantes en BAJO -->
        <div class="dashboard-section" id="dashboard-bajo">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-4" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control" id="filterGradoBajo" onchange="updateEstudiantesBajo()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="filterGrupoBajo" onchange="updateEstudiantesBajo()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-control" id="filterAreaBajo" onchange="updateEstudiantesBajo()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estudiante</label>
                        <input type="text" class="form-control" id="filterEstudianteBajo" placeholder="Buscar..." onkeyup="updateEstudiantesBajo()">
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFiltersBajo()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('bajo')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('bajo')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>‚ö†Ô∏è Estudiantes con Desempe√±o BAJO</h2>
                <div id="estudiantesBajoContent">
                    <p>Procese los archivos para ver los estudiantes con desempe√±o bajo.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard: Notas M√≠nimas -->
        <div class="dashboard-section" id="dashboard-minimas">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-4" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control" id="filterGradoMinimas" onchange="updateNotasMinimas()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="filterGrupoMinimas" onchange="updateNotasMinimas()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-control" id="filterAreaMinimas" onchange="updateNotasMinimas()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-control" id="filterEstadoMinimas" onchange="updateNotasMinimas()">
                            <option value="">Todos</option>
                            <option value="POSIBLE">Posible</option>
                            <option value="DIF√çCIL">Dif√≠cil</option>
                            <option value="CR√çTICO">Cr√≠tico</option>
                            <option value="IMPOSIBLE">Imposible</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFiltersMinimas()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('minimas')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('minimas')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìù Notas M√≠nimas Necesarias</h2>
                <div id="notasMinimasContent">
                    <p>Procese los archivos para ver las notas m√≠nimas necesarias.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard: Por Area -->
        <div class="dashboard-section" id="dashboard-area">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-3" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control" id="filterGradoArea" onchange="updatePorArea()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="filterGrupoArea" onchange="updatePorArea()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-control" id="filterAreaSelect" onchange="updatePorArea()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFiltersArea()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('Area')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('Area')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìö An√°lisis por Area</h2>
                <div id="AreaContent">
                    <p>Procese los archivos para ver el an√°lisis por Area.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard: Tendencias y Alertas -->
        <div class="dashboard-section" id="dashboard-alertas">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-4" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control" id="filterGradoAlertas" onchange="updateTendenciasAlertas()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="filterGrupoAlertas" onchange="updateTendenciasAlertas()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nivel de Riesgo</label>
                        <select class="form-control" id="filterRiesgoAlertas" onchange="updateTendenciasAlertas()">
                            <option value="">Todos</option>
                            <option value="ALTO">Alto</option>
                            <option value="MEDIO">Medio</option>
                            <option value="BAJO">Bajo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estudiante</label>
                        <input type="text" class="form-control" id="filterEstudianteAlertas" placeholder="Buscar..." onkeyup="updateTendenciasAlertas()">
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFiltersAlertas()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('alertas')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('alertas')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üîî Tendencias y Alertas Tempranas</h2>
                <div id="alertasContent">
                    <p>Procese los archivos para ver las tendencias y alertas.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard: An√°lisis de P√©rdida del A√±o -->
        <div class="dashboard-section" id="dashboard-perdida">
            <!-- Filtros -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
                <div class="grid grid-4" style="gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">Grado</label>
                        <select class="form-control" id="filterGradoPerdida" onchange="updateAnalisisPerdida()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grupo</label>
                        <select class="form-control" id="filterGrupoPerdida" onchange="updateAnalisisPerdida()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-control" id="filterEstadoPerdida" onchange="updateAnalisisPerdida()">
                            <option value="">Todos</option>
                            <option value="PERDIENDO">Perdiendo el A√±o</option>
                            <option value="CRITICO">En Riesgo Cr√≠tico</option>
                            <option value="DIFICIL">En Riesgo Dif√≠cil</option>
                            <option value="POSIBLE">En Riesgo Posible</option>
                            <option value="APROBANDO">Aprobando</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estudiante</label>
                        <input type="text" class="form-control" id="filterEstudiantePerdida" placeholder="Buscar..." onkeyup="updateAnalisisPerdida()">
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearFiltersPerdida()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-danger" onclick="exportToPDF('perdida')">üìÑ Exportar PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel('perdida')">üìä Exportar Excel</button>
                </div>
            </div>
            
            <div class="card">
                <h2>‚ö†Ô∏è An√°lisis de P√©rdida del A√±o</h2>
                <div id="perdidaContent">
                    <p>Procese los archivos para ver el an√°lisis de p√©rdida del a√±o.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- JavaScript (El mismo c√≥digo JS del archivo original) -->
    <script>
        // Copiar todo el c√≥digo JavaScript del archivo original aqu√≠
        // Variables globales
        let periodData = {1: null, 2: null, 3: null, 4: null};
        let processedData = null;
        let availableAreas = [];
        let selectedAreas = [];
        let studentsData = [];
        let colegioInfo = {
            nombre: '',
            logo: '',
            anoLectivo: '2024'
        };
        
        // Configuraci√≥n de escala
        let escalaConfig = {
            escala: 5,
            notaMinima: 3.0,
            periodoActual: 3,
            areasPerderAno: 3
        };

        // Funci√≥n para guardar el an√°lisis completo
        function saveAnalysis() {
            if (!processedData) {
                alert('No hay datos para guardar. Por favor, procese los archivos primero.');
                return;
            }
            
            const analysisData = {
                version: '1.0',
                fecha: new Date().toISOString(),
                colegioInfo: colegioInfo,
                escalaConfig: escalaConfig,
                weights: {
                    peso1: document.getElementById('peso1').value,
                    peso2: document.getElementById('peso2').value,
                    peso3: document.getElementById('peso3').value,
                    peso4: document.getElementById('peso4').value
                },
                selectedAreas: selectedAreas,
                studentsData: studentsData,
                processedData: {
                    totalStudents: processedData.totalStudents,
                    averageScore: processedData.averageScore,
                    performanceDistribution: processedData.performanceDistribution,
                    notasMinimas: processedData.notasMinimas,
                    analisisPerdida: processedData.analisisPerdida
                }
            };
            
            // Crear y descargar archivo JSON
            const dataStr = JSON.stringify(analysisData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'analisis_' + (colegioInfo.nombre || 'colegio').replace(/\s/g, '_') + '_' + new Date().getTime() + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('‚úÖ An√°lisis guardado exitosamente');
        }

        // Funci√≥n para cargar un an√°lisis guardado
        function loadAnalysis(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const analysisData = JSON.parse(e.target.result);
                    
                    // Validar versi√≥n
                    if (!analysisData.version) {
                        alert('Formato de archivo no v√°lido');
                        return;
                    }
                    
                    // Restaurar informaci√≥n del colegio
                    if (analysisData.colegioInfo) {
                        colegioInfo = analysisData.colegioInfo;
                        document.getElementById('nombreColegio').value = colegioInfo.nombre || '';
                        document.getElementById('anoLectivo').value = colegioInfo.anoLectivo || '2024';
                        updateColegioInfo();
                        
                        if (colegioInfo.logo) {
                            const preview = document.getElementById('logoPreview');
                            const previewImg = document.getElementById('logoPreviewImg');
                            
                            if (preview && previewImg) {
                                previewImg.src = colegioInfo.logo;
                                preview.style.display = 'block';
                            }
                        }
                    }
                    
                    // Restaurar configuraci√≥n de escala
                    if (analysisData.escalaConfig) {
                        escalaConfig = analysisData.escalaConfig;
                        document.getElementById('escalaCalificacion').value = escalaConfig.escala;
                        document.getElementById('notaAprobacion').value = escalaConfig.notaMinima;
                        document.getElementById('periodoActual').value = escalaConfig.periodoActual;
                        document.getElementById('areasPerderAno').value = escalaConfig.areasPerderAno || 3;
                    }
                    
                    // Restaurar pesos
                    if (analysisData.weights) {
                        document.getElementById('peso1').value = analysisData.weights.peso1;
                        document.getElementById('peso2').value = analysisData.weights.peso2;
                        document.getElementById('peso3').value = analysisData.weights.peso3;
                        document.getElementById('peso4').value = analysisData.weights.peso4;
                        updateTotalWeight();
                    }
                    
                    // Restaurar datos
                    if (analysisData.selectedAreas) {
                        selectedAreas = analysisData.selectedAreas;
                        availableAreas = [...selectedAreas];
                    }
                    
                    if (analysisData.studentsData) {
                        studentsData = analysisData.studentsData;
                    }
                    
                    if (analysisData.processedData) {
                        processedData = {
                            ...analysisData.processedData,
                            students: studentsData,
                            weights: {
                                1: parseFloat(analysisData.weights.peso1) / 100,
                                2: parseFloat(analysisData.weights.peso2) / 100,
                                3: parseFloat(analysisData.weights.peso3) / 100,
                                4: parseFloat(analysisData.weights.peso4) / 100
                            },
                            estudiantesBajo: studentsData.filter(s => s.performance === 'BAJO'),
                            estudiantesRiesgo: studentsData.filter(s => s.failedAreas >= 3),
                            areasStats: {}
                        };
                        
                        // Reconstruir areasStats
                        selectedAreas.forEach(area => {
                            processedData.areasStats[area] = {
                                scores: [],
                                periodos: {1: [], 2: [], 3: [], 4: []},
                                aprobados: 0,
                                reprobados: 0
                            };
                        });
                        
                        // Actualizar estad√≠sticas de √°reas
                        studentsData.forEach(student => {
                            Object.entries(student.areas).forEach(([areaName, areaData]) => {
                                if (processedData.areasStats[areaName]) {
                                    processedData.areasStats[areaName].scores.push(areaData.final);
                                    if (areaData.final >= escalaConfig.notaMinima) {
                                        processedData.areasStats[areaName].aprobados++;
                                    } else {
                                        processedData.areasStats[areaName].reprobados++;
                                    }
                                }
                            });
                        });
                    }
                    
                    // Actualizar UI
                    populateFilters();
                    updateGeneralDashboard();
                    updateEstudiantesBajo();
                    updateNotasMinimas();
                    updatePorArea();
                    updateTendenciasAlertas();
                    updateAnalisisPerdida();
                    
                    // Mostrar dashboard general
                    showDashboard('general', document.querySelector('.nav-tab:nth-child(2)'));
                    
                    alert('‚úÖ An√°lisis cargado exitosamente\n\nColegio: ' + (colegioInfo.nombre || 'Sin nombre') + 
                          '\nFecha: ' + new Date(analysisData.fecha).toLocaleDateString());
                    
                } catch (error) {
                    console.error('Error al cargar an√°lisis:', error);
                    alert('Error al cargar el archivo. Verifique que sea un archivo de an√°lisis v√°lido.');
                }
            };
            
            reader.readAsText(file);
        }

        // Funci√≥n para actualizar informaci√≥n del colegio
        function updateColegioInfo() {
            const nombre = document.getElementById('nombreColegio').value;
            const anoLectivo = document.getElementById('anoLectivo').value;
            
            colegioInfo.nombre = nombre;
            colegioInfo.anoLectivo = anoLectivo;
        }

        // Funci√≥n para manejar la carga del logo
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    colegioInfo.logo = e.target.result;
                    
                    // Mostrar preview
                    const preview = document.getElementById('logoPreview');
                    const previewImg = document.getElementById('logoPreviewImg');
                    
                    if (preview && previewImg) {
                        previewImg.src = colegioInfo.logo;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Funci√≥n para actualizar nota de aprobaci√≥n seg√∫n escala
        function updateNotaAprobacion() {
    const escala = parseFloat(document.getElementById('escalaCalificacion').value);
    const notaAprobacionInput = document.getElementById('notaAprobacion');
    
    let notaMinima;
    switch(escala) {
        case 5:
            notaMinima = 3.0;
            break;
        case 10:
            notaMinima = 6.0;
            break;
        case 50:
            notaMinima = 30.0;
            break;
        case 100:
            notaMinima = 60.0;
            break;
        default:
            notaMinima = escala * 0.6;
    }
    
    // ELIMINAR O COMENTAR ESTA L√çNEA PARA QUE NO CAMBIE AUTOM√ÅTICAMENTE
    // notaAprobacionInput.value = notaMinima;
    
    escalaConfig.escala = escala;
    // CAMBIAR ESTA L√çNEA PARA QUE USE EL VALOR ACTUAL DEL CAMPO
    escalaConfig.notaMinima = parseFloat(notaAprobacionInput.value);
}

// AGREGAR ESTA NUEVA FUNCI√ìN AQU√ç
function updateNotaAprobacionManual() {
    const valor = parseFloat(document.getElementById('notaAprobacion').value);
    if (!isNaN(valor) && valor >= 0) {
        escalaConfig.notaMinima = valor;
        console.log('Nota m√≠nima actualizada a:', valor);
    }
}

        // Funci√≥n para actualizar el peso total
        function updateTotalWeight() {
            const peso1 = parseFloat(document.getElementById('peso1').value) || 0;
            const peso2 = parseFloat(document.getElementById('peso2').value) || 0;
            const peso3 = parseFloat(document.getElementById('peso3').value) || 0;
            const peso4 = parseFloat(document.getElementById('peso4').value) || 0;
            
            const total = peso1 + peso2 + peso3 + peso4;
            document.getElementById('totalPeso').textContent = `Total: ${total}%`;
            
            if (Math.abs(total - 100) > 0.01) {
                document.getElementById('totalPeso').style.color = '#F44336';
            } else {
                document.getElementById('totalPeso').style.color = '#0D47A1';
            }
        }

        // Funci√≥n para mostrar/ocultar loading - Definida al principio
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.toggle('active', show);
            }
        }

        // Navegaci√≥n entre dashboards
        function showDashboard(name, tabElement) {
            console.log('Switching to dashboard:', name);
            
            // Ocultar todas las secciones
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Desactivar todos los tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            const dashboard = document.getElementById('dashboard-' + name);
            if (dashboard) {
                dashboard.classList.add('active');
            }
            
            // Activar el tab clickeado
            if (tabElement) {
                tabElement.classList.add('active');
            }
        }

        // Manejo de archivos
        function handleFileUpload(event, periodo) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Cargando archivo para periodo ' + periodo + ': ' + file.name);
            
            const uploadArea = document.getElementById('upload' + periodo);
            const filenameElement = document.getElementById('filename' + periodo);
            
            if (filenameElement) {
                filenameElement.textContent = '‚è≥ Procesando...';
                filenameElement.style.color = '#FF9800';
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    console.log('Libro cargado:', workbook.SheetNames);
                    
                    const allSheets = [];
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: "",
                            raw: false
                        });
                        
                        // Extraer informaci√≥n del nombre de la hoja
                        const match = sheetName.match(/(\d+)-(\d+)/);
                        const grado = match ? match[1] : 'N/A';
                        const grupo = match ? match[2] : 'N/A';
                        
                        allSheets.push({
                            sheet: sheetName,
                            grado: grado,
                            grupo: grupo,
                            data: jsonData
                        });
                    });
                    
                    periodData[periodo] = allSheets;
                    
                    // Actualizar UI
                    if (uploadArea) {
                        uploadArea.classList.add('loaded');
                    }
                    
                    if (filenameElement) {
                        filenameElement.innerHTML = '<strong>‚úÖ ' + file.name + '</strong>';
                        filenameElement.style.color = '#4CAF50';
                    }
                    
                    console.log('‚úÖ Periodo ' + periodo + ' cargado exitosamente');
                    
                } catch (error) {
                    console.error('Error al procesar archivo:', error);
                    
                    if (filenameElement) {
                        filenameElement.innerHTML = '<strong>‚ùå Error al cargar</strong>';
                        filenameElement.style.color = '#F44336';
                    }
                    
                    alert('Error al procesar el archivo: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('Error al leer archivo:', error);
                alert('Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Procesar archivos
        function processFiles() {
            console.log('Procesando archivos...');
            
            const hasFiles = Object.values(periodData).some(data => data !== null);
            if (!hasFiles) {
                alert('Por favor, cargue al menos un archivo Excel');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    extractAreas();
                    
                    const areasCard = document.getElementById('areasCard');
                    if (areasCard) {
                        areasCard.style.display = 'block';
                    }
                    
                    showLoading(false);
                    console.log('‚úÖ Archivos procesados');
                } catch (error) {
                    showLoading(false);
                    console.error('Error:', error);
                    alert('Error al procesar archivos: ' + error.message);
                }
            }, 100);
        }

        // Extraer √°reas de los archivos
        function extractAreas() {
            console.log('Extrayendo √°reas...');
            const areasSet = new Set();
            
            Object.entries(periodData).forEach(([periodo, data]) => {
                if (data) {
                    data.forEach(sheetData => {
                        if (sheetData.data && sheetData.data[6]) {
                            const areaRow = sheetData.data[6];
                            
                            // Las √°reas suelen estar en columnas impares
                            for (let i = 1; i < areaRow.length; i += 2) {
                                const area = String(areaRow[i] || '').trim();
                                
                                if (area && area.length > 2) {
                                    // Filtrar t√©rminos que no son √°reas
                                    const excludeTerms = ['Total', 'Promedio', 'Comportamiento', 
                                                        'Asistencia', 'Puesto', 'Apoyo', 'Observaciones'];
                                    
                                    if (!excludeTerms.some(term => area.includes(term))) {
                                        areasSet.add(area);
                                    }
                                }
                            }
                        }
                    });
                }
            });
            
            availableAreas = Array.from(areasSet).sort();
            console.log('√Åreas encontradas:', availableAreas);
            
            if (availableAreas.length === 0) {
                alert('No se encontraron √°reas en los archivos. Verifique el formato.');
            } else {
                displayAreas();
            }
        }

        // Mostrar √°reas disponibles
        function displayAreas() {
            const grid = document.getElementById('areasGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            availableAreas.forEach((area, index) => {
                const div = document.createElement('div');
                div.className = 'area-item';
                div.innerHTML = '<input type="checkbox" id="area' + index + '" value="' + area + '" checked>' +
                               '<label for="area' + index + '">' + area + '</label>';
                grid.appendChild(div);
            });
        }

        // Limpiar archivos
        function clearFiles() {
            if (!confirm('¬øEst√° seguro de limpiar todos los archivos?')) return;
            
            for (let i = 1; i <= 4; i++) {
                periodData[i] = null;
                
                const fileInput = document.getElementById('file' + i);
                const uploadArea = document.getElementById('upload' + i);
                const filenameElement = document.getElementById('filename' + i);
                
                if (fileInput) fileInput.value = '';
                if (uploadArea) {
                    uploadArea.classList.remove('loaded');
                }
                if (filenameElement) filenameElement.textContent = '';
            }
            
            const areasCard = document.getElementById('areasCard');
            if (areasCard) {
                areasCard.style.display = 'none';
            }
            
            processedData = null;
            availableAreas = [];
            selectedAreas = [];
            studentsData = [];
            
            console.log('‚úÖ Archivos limpiados');
        }

        function selectAllAreas() {
            document.querySelectorAll('#areasGrid input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllAreas() {
            document.querySelectorAll('#areasGrid input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Generar estad√≠sticas - Versi√≥n mejorada
        function generateStatistics() {
            console.log('Generando estad√≠sticas...');
            
            // Validar porcentajes
            const peso1 = parseFloat(document.getElementById('peso1').value || 0);
            const peso2 = parseFloat(document.getElementById('peso2').value || 0);
            const peso3 = parseFloat(document.getElementById('peso3').value || 0);
            const peso4 = parseFloat(document.getElementById('peso4').value || 0);
            
            const total = peso1 + peso2 + peso3 + peso4;
            
            if (Math.abs(total - 100) > 0.01) {
                alert('Los porcentajes deben sumar 100%. Actualmente suman: ' + total + '%');
                return;
            }
            
            // Obtener √°reas seleccionadas
            selectedAreas = [];
            document.querySelectorAll('#areasGrid input[type="checkbox"]:checked').forEach(cb => {
                selectedAreas.push(cb.value);
            });
            
            if (selectedAreas.length === 0) {
                alert('Por favor, seleccione al menos un √°rea');
                return;
            }
            
            showLoading(true);
            
            setTimeout(() => {
                try {
                    // Procesar todos los datos
                    processAllData();
                    
                    // Verificar que los datos se procesaron correctamente
                    if (processedData && processedData.totalStudents > 0) {
                        console.log('‚úÖ Estad√≠sticas generadas exitosamente');
                        console.log('Total estudiantes:', processedData.totalStudents);
                        console.log('Estudiantes en riesgo alto:', studentsData.filter(s => s.predictions && s.predictions.risk === 'ALTO').length);
                        console.log('An√°lisis p√©rdida - Perdiendo:', processedData.analisisPerdida.perdiendo.length);
                        
                        // Mostrar dashboard general
                        showDashboard('general', document.querySelector('.nav-tab:nth-child(2)'));
                        
                        alert('‚úÖ Estad√≠sticas generadas exitosamente\n\n' +
                              'Total estudiantes: ' + processedData.totalStudents + '\n' +
                              'Promedio general: ' + processedData.averageScore);
                    } else {
                        alert('‚ö†Ô∏è No se pudieron generar las estad√≠sticas. Verifique los datos de entrada.');
                    }
                    
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    console.error('Error al generar estad√≠sticas:', error);
                    alert('Error al generar estad√≠sticas: ' + error.message);
                }
            }, 100);
        }

        // PROCESAMIENTO COMPLETO DE DATOS - VERSI√ìN CORREGIDA
        function processAllData() {
            console.log('=== INICIANDO PROCESAMIENTO DE DATOS ===');
            
            const weights = {
                1: parseFloat(document.getElementById('peso1').value) / 100,
                2: parseFloat(document.getElementById('peso2').value) / 100,
                3: parseFloat(document.getElementById('peso3').value) / 100,
                4: parseFloat(document.getElementById('peso4').value) / 100
            };
            
            console.log('Pesos configurados:', weights);
            
            // Reiniciar estructuras de datos
            studentsData = [];
            const areasStats = {};
            selectedAreas.forEach(area => {
                areasStats[area] = { 
                    scores: [],
                    periodos: {1: [], 2: [], 3: [], 4: []},
                    aprobados: 0,
                    reprobados: 0
                };
            });
            
            // Procesar cada periodo
            Object.entries(periodData).forEach(([periodo, data]) => {
                if (data) {
                    console.log('\nProcesando Periodo ' + periodo + ':');
                    data.forEach(sheetData => {
                        processSheetData(sheetData, periodo, weights[periodo], areasStats);
                    });
                }
            });
            
            // Calcular estad√≠sticas finales
            calculateFinalScores(weights);
            
            // Calcular nota m√≠nima necesaria para cada estudiante
            calculateMinimumGrades(weights);
            
            // Generar predicciones ANTES de usar los datos
            generatePredictions();
            
            // Calcular an√°lisis de p√©rdida ANTES de usar los datos
            const analisisPerdida = calculateAnalisisPerdida(weights);
            
            // Calcular notas m√≠nimas ANTES de usar los datos
            const notasMinimas = calculateNotasMinimas(weights);
            
            // Calcular estad√≠sticas globales
            processedData = {
                totalStudents: studentsData.length,
                averageScore: calculateAverage(studentsData.map(s => s.finalScore)),
                areasStats: areasStats,
                performanceDistribution: calculatePerformanceDistribution(),
                students: studentsData,
                weights: weights,
                estudiantesBajo: studentsData.filter(s => s.performance === 'BAJO'),
                estudiantesRiesgo: studentsData.filter(s => s.failedAreas >= 3),
                notasMinimas: notasMinimas,
                analisisPerdida: analisisPerdida
            };
            
            console.log('=== PROCESAMIENTO COMPLETADO ===');
            console.log('Total estudiantes procesados:', processedData.totalStudents);
            console.log('Promedio general:', processedData.averageScore);
            console.log('Estudiantes en BAJO:', processedData.estudiantesBajo.length);
            console.log('An√°lisis p√©rdida a√±o - Perdiendo:', processedData.analisisPerdida.perdiendo.length);
            
            // Poblar filtros
            populateFilters();
            
            // Actualizar TODOS los dashboards
            try {
                updateGeneralDashboard();
                console.log('Dashboard general actualizado');
            } catch (e) {
                console.error('Error actualizando dashboard general:', e);
            }
            
            try {
                updateEstudiantesBajo();
                console.log('Dashboard estudiantes bajo actualizado');
            } catch (e) {
                console.error('Error actualizando estudiantes bajo:', e);
            }
            
            try {
                updateNotasMinimas();
                console.log('Dashboard notas m√≠nimas actualizado');
            } catch (e) {
                console.error('Error actualizando notas m√≠nimas:', e);
            }
            
            try {
                updatePorArea();
                console.log('Dashboard por √°rea actualizado');
            } catch (e) {
                console.error('Error actualizando por √°rea:', e);
            }
            
            try {
                updateTendenciasAlertas();
                console.log('Dashboard tendencias actualizado');
            } catch (e) {
                console.error('Error actualizando tendencias:', e);
            }
            
            try {
                updateAnalisisPerdida();
                console.log('Dashboard an√°lisis p√©rdida actualizado');
            } catch (e) {
                console.error('Error actualizando an√°lisis p√©rdida:', e);
            }
        }

        // Procesar datos de una hoja
        function processSheetData(sheetData, periodo, weight, areasStats) {
            const data = sheetData.data;
            if (!data || data.length < 8) {
                console.log('Hoja ' + sheetData.sheet + ' sin datos suficientes');
                return;
            }
            
            console.log('Procesando hoja: ' + sheetData.sheet + ' (' + sheetData.grado + '-' + sheetData.grupo + ')');
            
            // Identificar columnas de √°reas (fila 7, √≠ndice 6)
            const areaRow = data[6];
            const areaColumns = [];
            
            selectedAreas.forEach(area => {
                for (let i = 1; i < areaRow.length; i += 2) {
                    if (String(areaRow[i] || '').trim() === area) {
                        areaColumns.push({
                            area: area,
                            calIndex: i,
                            jvIndex: i + 1
                        });
                        break;
                    }
                }
            });
            
            console.log('√Åreas encontradas en esta hoja:', areaColumns.map(a => a.area));
            
            // Procesar estudiantes (empiezan en fila 8, √≠ndice 7)
            let estudiantesProcesados = 0;
            for (let row = 7; row < data.length; row++) {
                const studentRow = data[row];
                if (!studentRow || !studentRow[0]) continue;
                
                const studentName = String(studentRow[0]).trim();
                if (!studentName || studentName === '') continue;
                
                // Buscar o crear estudiante
                let student = studentsData.find(s => 
                    s.name === studentName && 
                    s.grado === sheetData.grado && 
                    s.grupo === sheetData.grupo
                );
                
                if (!student) {
                    student = {
                        name: studentName,
                        grado: sheetData.grado,
                        grupo: sheetData.grupo,
                        areas: {},
                        periodos: {},
                        finalScore: 0,
                        acumulado: 0,
                        performance: '',
                        failedAreas: 0,
                        notasMinimas: {},
                        predictions: {}
                    };
                    studentsData.push(student);
                }
                
                // Inicializar periodo si no existe
                if (!student.periodos[periodo]) {
                    student.periodos[periodo] = {
                        promedio: 0,
                        areas: {}
                    };
                }
                
                // Registrar notas por √°rea
                areaColumns.forEach(areaCol => {
                    const cal = parseFloat(studentRow[areaCol.calIndex]) || 0;
                    const jv = studentRow[areaCol.jvIndex] || getDesempeno(cal);
                    
                    // Inicializar √°rea si no existe
                    if (!student.areas[areaCol.area]) {
                        student.areas[areaCol.area] = {
                            periodos: {},
                            final: 0,
                            jvFinal: '',
                            notaMinima: 0,
                            estadoAprobacion: ''
                        };
                    }
                    
                    // Guardar datos del periodo
                    student.areas[areaCol.area].periodos[periodo] = {
                        cal: cal,
                        jv: jv,
                        weight: weight
                    };
                    
                    // Guardar en estad√≠sticas del √°rea
                    areasStats[areaCol.area].scores.push(cal);
                    areasStats[areaCol.area].periodos[periodo].push({
                        student: studentName,
                        score: cal,
                        jv: jv
                    });
                });
                
                estudiantesProcesados++;
            }
            
            console.log('Estudiantes procesados en esta hoja: ' + estudiantesProcesados);
        }

        // Calcular notas finales
        function calculateFinalScores(weights) {
            console.log('\nCalculando notas finales...');
            
            studentsData.forEach(student => {
                let totalScore = 0;
                let totalAreas = 0;
                student.failedAreas = 0;
                
                // Calcular promedio por √°rea
                Object.entries(student.areas).forEach(([areaName, areaData]) => {
                    let areaTotal = 0;
                    let areaWeight = 0;
                    
                    // Sumar notas ponderadas de cada periodo
                    Object.entries(areaData.periodos).forEach(([periodo, data]) => {
                        areaTotal += data.cal * data.weight;
                        areaWeight += data.weight;
                    });
                    
                    // Calcular nota final del √°rea
                    areaData.final = areaWeight > 0 ? areaTotal / areaWeight : 0;
                    areaData.jvFinal = getDesempeno(areaData.final);
                    
                    // Contar √°reas perdidas
                    if (areaData.final < escalaConfig.notaMinima) {
                        student.failedAreas++;
                    }
                    
                    totalScore += areaData.final;
                    totalAreas++;
                });
                
                // Calcular promedio general del estudiante
                student.finalScore = totalAreas > 0 ? totalScore / totalAreas : 0;
                student.acumulado = student.finalScore;
                student.performance = getDesempeno(student.finalScore);
            });
            
            console.log('Notas finales calculadas para', studentsData.length, 'estudiantes');
        }

        // Calcular notas m√≠nimas necesarias
        function calculateMinimumGrades(weights) {
            console.log('\nCalculando notas m√≠nimas necesarias...');
            
            const periodoActual = parseInt(document.getElementById('periodoActual').value);
            
            studentsData.forEach(student => {
                Object.entries(student.areas).forEach(([areaName, areaData]) => {
                    let acumulado = 0;
                    let pesoAcumulado = 0;
                    
                    // Calcular acumulado hasta el periodo actual
                    for (let p = 1; p <= periodoActual; p++) {
                        if (areaData.periodos[p]) {
                            acumulado += areaData.periodos[p].cal * weights[p];
                            pesoAcumulado += weights[p];
                        }
                    }
                    
                    // Calcular peso restante
                    let pesoRestante = 0;
                    for (let p = periodoActual + 1; p <= 4; p++) {
                        pesoRestante += weights[p];
                    }
                    
                    // Calcular nota necesaria
                    const notaNecesaria = pesoRestante > 0 ? 
                        (escalaConfig.notaMinima - acumulado) / pesoRestante : 0;
                    
                    areaData.notaMinima = notaNecesaria;
                    areaData.acumulado = acumulado;
                    areaData.pesoAcumulado = pesoAcumulado * 100;
                    areaData.pesoRestante = pesoRestante * 100;
                    
                    // Determinar estado de aprobaci√≥n
                    if (notaNecesaria <= 0) {
                        areaData.estadoAprobacion = 'APROBADO';
                    } else if (notaNecesaria <= escalaConfig.notaMinima) {
                        areaData.estadoAprobacion = 'POSIBLE';
                    } else if (notaNecesaria <= escalaConfig.escala * 0.8) {
                        areaData.estadoAprobacion = 'DIF√çCIL';
                    } else if (notaNecesaria <= escalaConfig.escala) {
                        areaData.estadoAprobacion = 'CR√çTICO';
                    } else {
                        areaData.estadoAprobacion = 'IMPOSIBLE';
                    }
                });
            });
        }

        // Calcular notas m√≠nimas globales
        function calculateNotasMinimas(weights) {
            const notasMinimas = [];
            
            studentsData.forEach(student => {
                Object.entries(student.areas).forEach(([areaName, areaData]) => {
                    if (areaData.final < escalaConfig.notaMinima || areaData.estadoAprobacion !== 'APROBADO') {
                        notasMinimas.push({
                            estudiante: student.name,
                            grado: student.grado,
                            grupo: student.grupo,
                            area: areaName,
                            acumulado: areaData.acumulado || areaData.final,
                            pesoAcumulado: areaData.pesoAcumulado || 75,
                            pesoRestante: areaData.pesoRestante || 25,
                            notaMinima: areaData.notaMinima,
                            estado: areaData.estadoAprobacion
                        });
                    }
                });
            });
            
            return notasMinimas;
        }

        // Generar predicciones
        function generatePredictions() {
            console.log('\nGenerando predicciones...');
            
            studentsData.forEach(student => {
                const scores = [];
                
                // Recolectar promedios por periodo
                for (let p = 1; p <= 4; p++) {
                    let periodScore = 0;
                    let count = 0;
                    
                    Object.values(student.areas).forEach(area => {
                        if (area.periodos[p]) {
                            periodScore += area.periodos[p].cal;
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        scores.push(periodScore / count);
                    }
                }
                
                // Calcular tendencia
                const trend = calculateTrend(scores);
                
                // Calcular probabilidad de p√©rdida
                let probability = 0;
                
                // Factores de riesgo basados en escala
                const notaMinima = escalaConfig.notaMinima;
                if (student.finalScore < notaMinima * 0.5) probability += 40;
                else if (student.finalScore < notaMinima * 0.75) probability += 30;
                else if (student.finalScore < notaMinima) probability += 20;
                else if (student.finalScore < notaMinima * 1.2) probability += 10;
                
                if (student.failedAreas >= 3) probability += 30;
                else if (student.failedAreas >= 2) probability += 20;
                else if (student.failedAreas >= 1) probability += 10;
                
                if (trend < -0.5) probability += 20;
                else if (trend < 0) probability += 10;
                
                // √Åreas cr√≠ticas
                const areasImposibles = Object.values(student.areas)
                    .filter(a => a.estadoAprobacion === 'IMPOSIBLE').length;
                const areasCriticas = Object.values(student.areas)
                    .filter(a => a.estadoAprobacion === 'CR√çTICO').length;
                
                probability += areasImposibles * 15;
                probability += areasCriticas * 8;
                
                student.predictions = {
                    probability: Math.min(probability, 100),
                    trend: trend,
                    risk: probability > 70 ? 'ALTO' : probability > 40 ? 'MEDIO' : 'BAJO',
                    tendencia: trend > 0.1 ? 'MEJORANDO' : trend < -0.1 ? 'EMPEORANDO' : 'ESTABLE'
                };
            });
        }

        // Calcular tendencia
        function calculateTrend(scores) {
            if (scores.length < 2) return 0;
            
            // Calcular pendiente de la l√≠nea de tendencia
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            const n = scores.length;
            
            for (let i = 0; i < n; i++) {
                sumX += i;
                sumY += scores[i];
                sumXY += i * scores[i];
                sumX2 += i * i;
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            return slope;
        }

        // Obtener desempe√±o seg√∫n nota
        function getDesempeno(score) {
            const escala = escalaConfig.escala;
            const notaMinima = escalaConfig.notaMinima;
            
            if (score >= escala * 0.92) return 'SUPERIOR';
            if (score >= escala * 0.8) return 'ALTO';
            if (score >= notaMinima) return 'B√ÅSICO';
            return 'BAJO';
        }

        // Calcular promedio
        function calculateAverage(values) {
            if (!values || values.length === 0) return 0;
            const sum = values.reduce((a, b) => a + b, 0);
            return (sum / values.length).toFixed(2);
        }

        // Calcular distribuci√≥n de desempe√±o
        function calculatePerformanceDistribution() {
            const distribution = { 
                SUPERIOR: 0, 
                ALTO: 0, 
                B√ÅSICO: 0, 
                BAJO: 0 
            };
            
            studentsData.forEach(student => {
                distribution[student.performance]++;
            });
            
            return distribution;
        }

        // Calcular an√°lisis de p√©rdida del a√±o
        function calculateAnalisisPerdida(weights) {
            const areasPerderAno = parseInt(document.getElementById('areasPerderAno')?.value || 3);
            escalaConfig.areasPerderAno = areasPerderAno;
            
            const analisis = {
                perdiendo: [],
                critico: [],
                dificil: [],
                posible: [],
                aprobando: [],
                porGrado: {}
            };
            
            studentsData.forEach(student => {
                // Contar √°reas que van perdiendo (estado IMPOSIBLE o CR√çTICO)
                let areasImposibles = 0;
                let areasCriticas = 0;
                let areasDificiles = 0;
                let areasPosibles = 0;
                
                Object.values(student.areas).forEach(area => {
                    if (area.estadoAprobacion === 'IMPOSIBLE') areasImposibles++;
                    else if (area.estadoAprobacion === 'CR√çTICO') areasCriticas++;
                    else if (area.estadoAprobacion === 'DIF√çCIL') areasDificiles++;
                    else if (area.estadoAprobacion === 'POSIBLE') areasPosibles++;
                });
                
                // Clasificar estudiante
                let estadoAno = '';
                let areasPerdiendoTotal = areasImposibles + areasCriticas;
                
                if (areasImposibles >= areasPerderAno) {
                    estadoAno = 'PERDIENDO';
                    analisis.perdiendo.push(student);
                } else if (areasImposibles + areasCriticas >= areasPerderAno) {
                    estadoAno = 'CRITICO';
                    analisis.critico.push(student);
                } else if (areasImposibles + areasCriticas + areasDificiles >= areasPerderAno) {
                    estadoAno = 'DIFICIL';
                    analisis.dificil.push(student);
                } else if (areasImposibles + areasCriticas + areasDificiles + areasPosibles >= areasPerderAno) {
                    estadoAno = 'POSIBLE';
                    analisis.posible.push(student);
                } else {
                    estadoAno = 'APROBANDO';
                    analisis.aprobando.push(student);
                }
                
                // Agregar a estad√≠sticas por grado
                const gradoKey = student.grado + '-' + student.grupo;
                if (!analisis.porGrado[gradoKey]) {
                    analisis.porGrado[gradoKey] = {
                        total: 0,
                        perdiendo: 0,
                        critico: 0,
                        dificil: 0,
                        posible: 0,
                        aprobando: 0
                    };
                }
                
                analisis.porGrado[gradoKey].total++;
                analisis.porGrado[gradoKey][estadoAno.toLowerCase()]++;
                
                // Guardar estado en el estudiante
                student.estadoAno = estadoAno;
                student.areasImposibles = areasImposibles;
                student.areasCriticas = areasCriticas;
                student.areasDificiles = areasDificiles;
                student.areasPosibles = areasPosibles;
                student.totalAreasPerdiendo = areasPerdiendoTotal;
            });
            
            return analisis;
        }

        // Poblar los selectores de filtros con opciones √∫nicas
        function populateFilters() {
            if (!processedData || !studentsData) return;
            
            // Obtener valores √∫nicos
            const grados = [...new Set(studentsData.map(s => s.grado))].sort();
            const grupos = [...new Set(studentsData.map(s => s.grupo))].sort();
            const areas = selectedAreas.sort();
            
            // Selectores de grado
            const gradoSelectors = [
                'filterGrado', 'filterGradoBajo', 'filterGradoMinimas', 
                'filterGradoArea', 'filterGradoAlertas', 'filterGradoPerdida'
            ];
            
            gradoSelectors.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Todos</option>';
                    grados.forEach(grado => {
                        select.innerHTML += '<option value="' + grado + '">' + grado + '</option>';
                    });
                    select.value = currentValue;
                }
            });
            
            // Selectores de grupo
            const grupoSelectors = [
                'filterGrupo', 'filterGrupoBajo', 'filterGrupoMinimas',
                'filterGrupoArea', 'filterGrupoAlertas', 'filterGrupoPerdida'
            ];
            
            grupoSelectors.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Todos</option>';
                    grupos.forEach(grupo => {
                        select.innerHTML += '<option value="' + grupo + '">' + grupo + '</option>';
                    });
                    select.value = currentValue;
                }
            });
            
            // Selectores de √°rea
            const areaSelectors = [
                'filterArea', 'filterAreaBajo', 'filterAreaMinimas', 'filterAreaSelect'
            ];
            
            areaSelectors.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Todas</option>';
                    areas.forEach(area => {
                        select.innerHTML += '<option value="' + area + '">' + area + '</option>';
                    });
                    select.value = currentValue;
                }
            });
        }

        // FUNCIONES DE ACTUALIZACI√ìN DE DASHBOARDS - Definidas ANTES de processAllData
        function updateGeneralDashboard() {
            if (!processedData) return;
            
            const totalStudents = processedData.totalStudents;
            const averageScore = processedData.averageScore;
            const distribution = processedData.performanceDistribution;
            const enRiesgo = processedData.estudiantesRiesgo.length;
            const enBajo = processedData.estudiantesBajo.length;
            
            const generalContent = document.getElementById('generalContent');
            if (generalContent) {
                let htmlContent = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">';
                
                // Card Total Estudiantes
                htmlContent += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">';
                htmlContent += '<div style="font-size: 12px; opacity: 0.9;">Total Estudiantes</div>';
                htmlContent += '<div style="font-size: 32px; font-weight: bold;">' + totalStudents + '</div>';
                htmlContent += '</div>';
                
                // Card Promedio General
                htmlContent += '<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">';
                htmlContent += '<div style="font-size: 12px; opacity: 0.9;">Promedio General</div>';
                htmlContent += '<div style="font-size: 32px; font-weight: bold;">' + averageScore + '</div>';
                htmlContent += '</div>';
                
                // Card En Riesgo
                htmlContent += '<div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">';
                htmlContent += '<div style="font-size: 12px; opacity: 0.9;">En Riesgo (3+ √°reas)</div>';
                htmlContent += '<div style="font-size: 32px; font-weight: bold;">' + enRiesgo + '</div>';
                htmlContent += '</div>';
                
                // Card En Bajo
                htmlContent += '<div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px;">';
                htmlContent += '<div style="font-size: 12px; opacity: 0.9;">En Bajo</div>';
                htmlContent += '<div style="font-size: 32px; font-weight: bold;">' + enBajo + '</div>';
                htmlContent += '</div>';
                
                htmlContent += '</div>';
                
                // Distribuci√≥n de Desempe√±o
                htmlContent += '<h3 style="margin-top: 30px;">üìà Distribuci√≥n de Desempe√±o</h3>';
                htmlContent += '<div style="margin-top: 20px;">';
                htmlContent += '<div style="background: #f0f0f0; padding: 15px; border-radius: 8px;">';
                
                const colors = {
                    'SUPERIOR': '#4CAF50',
                    'ALTO': '#2196F3',
                    'B√ÅSICO': '#FF9800',
                    'BAJO': '#F44336'
                };
                
                for (const [nivel, count] of Object.entries(distribution)) {
                    const percentage = totalStudents > 0 ? (count / totalStudents * 100).toFixed(1) : 0;
                    htmlContent += '<div style="margin-bottom: 10px;">';
                    htmlContent += '<strong>' + nivel + ':</strong> ';
                    htmlContent += '<span>' + count + ' estudiantes (' + percentage + '%)</span>';
                    htmlContent += '<div style="background: ' + colors[nivel] + '; height: 20px; width: ' + percentage + '%; border-radius: 4px; margin-top: 5px;"></div>';
                    htmlContent += '</div>';
                }
                
                htmlContent += '</div></div>';
                
                generalContent.innerHTML = htmlContent;
            }
        }

        function updateEstudiantesBajo() {
            if (!processedData) return;
            
            const content = document.getElementById('estudiantesBajoContent');
            if (!content) return;
            
            const estudiantesBajo = processedData.estudiantesBajo;
            
            let htmlContent = '<div style="margin-bottom: 20px;">';
            htmlContent += '<div style="background: #ffebee; border-left: 4px solid #f44336; padding: 15px; border-radius: 4px;">';
            htmlContent += '<strong>' + estudiantesBajo.length + '</strong> estudiantes encontrados con desempe√±o BAJO';
            htmlContent += '</div></div>';
            
            htmlContent += '<div style="overflow-x: auto;">';
            htmlContent += '<table style="width: 100%; border-collapse: collapse; background: white;">';
            htmlContent += '<thead><tr style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); color: white;">';
            htmlContent += '<th style="padding: 12px; text-align: left;">Estudiante</th>';
            htmlContent += '<th style="padding: 12px;">Grado-Grupo</th>';
            htmlContent += '<th style="padding: 12px;">Promedio</th>';
            htmlContent += '<th style="padding: 12px;">√Åreas Perdidas</th>';
            htmlContent += '<th style="padding: 12px;">Estado</th>';
            htmlContent += '</tr></thead><tbody>';
            
            if (estudiantesBajo.length === 0) {
                htmlContent += '<tr><td colspan="5" style="text-align: center; padding: 20px;">No se encontraron estudiantes con desempe√±o bajo</td></tr>';
            } else {
                estudiantesBajo.slice(0, 50).forEach((est, index) => {
                    const bgColor = index % 2 === 0 ? 'background: #f5f5f5;' : '';
                    htmlContent += '<tr style="border-bottom: 1px solid #eee; ' + bgColor + '">';
                    htmlContent += '<td style="padding: 12px;">' + est.name + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + est.grado + '-' + est.grupo + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center; font-weight: bold; color: #f44336;">' + est.finalScore.toFixed(2) + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + est.failedAreas + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">';
                    htmlContent += '<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">BAJO</span>';
                    htmlContent += '</td>';
                    htmlContent += '</tr>';
                });
            }
            
            htmlContent += '</tbody></table></div>';
            
            content.innerHTML = htmlContent;
        }

        function updateNotasMinimas() {
            console.log('Actualizando notas m√≠nimas...');
            if (!processedData || !processedData.notasMinimas) return;
            
            const content = document.getElementById('notasMinimasContent');
            if (!content) return;
            
            const notasMinimas = processedData.notasMinimas;
            
            let htmlContent = '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            htmlContent += '<strong>Configuraci√≥n:</strong> ';
            htmlContent += 'Escala ' + escalaConfig.escala + ' | ';
            htmlContent += 'Nota m√≠nima: ' + escalaConfig.notaMinima;
            htmlContent += '</div>';
            
            htmlContent += '<div style="overflow-x: auto;">';
            htmlContent += '<table style="width: 100%; border-collapse: collapse; background: white;">';
            htmlContent += '<thead><tr style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white;">';
            htmlContent += '<th style="padding: 12px;">Estudiante</th>';
            htmlContent += '<th style="padding: 12px;">Grupo</th>';
            htmlContent += '<th style="padding: 12px;">√Årea</th>';
            htmlContent += '<th style="padding: 12px;">Acumulado</th>';
            htmlContent += '<th style="padding: 12px;">% Cursado</th>';
            htmlContent += '<th style="padding: 12px;">Nota Necesaria</th>';
            htmlContent += '<th style="padding: 12px;">Estado</th>';
            htmlContent += '</tr></thead><tbody>';
            
            if (notasMinimas.length === 0) {
                htmlContent += '<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay notas m√≠nimas que calcular</td></tr>';
            } else {
                notasMinimas.slice(0, 50).forEach((nota, index) => {
                    const bgColor = index % 2 === 0 ? 'background: #f5f5f5;' : '';
                    const estadoColor = {
                        'POSIBLE': '#4CAF50',
                        'DIF√çCIL': '#FF9800',
                        'CR√çTICO': '#FF5722',
                        'IMPOSIBLE': '#F44336',
                        'APROBADO': '#2196F3'
                    };
                    
                    htmlContent += '<tr style="border-bottom: 1px solid #eee; ' + bgColor + '">';
                    htmlContent += '<td style="padding: 12px;">' + nota.estudiante + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + nota.grado + '-' + nota.grupo + '</td>';
                    htmlContent += '<td style="padding: 12px;">' + nota.area + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + nota.acumulado.toFixed(2) + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + nota.pesoAcumulado.toFixed(0) + '%</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center; font-weight: bold;">';
                    htmlContent += nota.notaMinima > 0 ? nota.notaMinima.toFixed(2) : 'N/A';
                    htmlContent += '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">';
                    htmlContent += '<span style="background: ' + estadoColor[nota.estado] + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">';
                    htmlContent += nota.estado + '</span>';
                    htmlContent += '</td>';
                    htmlContent += '</tr>';
                });
            }
            
            htmlContent += '</tbody></table></div>';
            
            content.innerHTML = htmlContent;
        }

        function updatePorArea() {
            console.log('Actualizando por √°rea...');
            if (!processedData || !processedData.areasStats) return;
            
            const content = document.getElementById('AreaContent');
            if (!content) return;
            
            // Obtener filtros aplicados
            const filtroGrado = document.getElementById('filterGradoArea')?.value || '';
            const filtroGrupo = document.getElementById('filterGrupoArea')?.value || '';
            const filtroArea = document.getElementById('filterAreaSelect')?.value || '';
            
            let htmlContent = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">';
            
            Object.entries(processedData.areasStats).forEach(([areaName, stats]) => {
                if (filtroArea && areaName !== filtroArea) return;
                
                // Filtrar estudiantes seg√∫n criterios
                let estudiantesFiltrados = studentsData.filter(s => s.areas[areaName]);
                
                if (filtroGrado) {
                    estudiantesFiltrados = estudiantesFiltrados.filter(s => s.grado === filtroGrado);
                }
                if (filtroGrupo) {
                    estudiantesFiltrados = estudiantesFiltrados.filter(s => s.grupo === filtroGrupo);
                }
                
                const total = estudiantesFiltrados.length;
                if (total === 0) return;
                
                // Calcular estad√≠sticas con estudiantes filtrados
                const scores = estudiantesFiltrados.map(s => s.areas[areaName].final);
                const promedio = scores.reduce((a, b) => a + b, 0) / total;
                const aprobados = estudiantesFiltrados.filter(s => s.areas[areaName].final >= escalaConfig.notaMinima).length;
                const reprobados = total - aprobados;
                const porcentajeAprobacion = (aprobados / total * 100).toFixed(1);
                const porcentajeReprobacion = (reprobados / total * 100).toFixed(1);
                
                // Calcular distribuci√≥n por desempe√±o
                let superior = 0, alto = 0, basico = 0, bajo = 0;
                
                scores.forEach(score => {
                    const desempeno = getDesempeno(score);
                    switch(desempeno) {
                        case 'SUPERIOR': superior++; break;
                        case 'ALTO': alto++; break;
                        case 'B√ÅSICO': basico++; break;
                        case 'BAJO': bajo++; break;
                    }
                });
                
                // Obtener top 5 estudiantes
                const topEstudiantes = estudiantesFiltrados
                    .sort((a, b) => b.areas[areaName].final - a.areas[areaName].final)
                    .slice(0, 5)
                    .map(s => ({
                        nombre: s.name,
                        grado: s.grado,
                        grupo: s.grupo,
                        nota: s.areas[areaName].final
                    }));
                
                htmlContent += '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white;">';
                
                // T√≠tulo del √°rea
                htmlContent += '<h4 style="color: #1976d2; margin-bottom: 15px; font-size: 16px;">' + areaName + '</h4>';
                
                // Estad√≠sticas principales
                htmlContent += '<div style="font-size: 14px; color: #666; margin-bottom: 10px;">';
                htmlContent += '<div style="margin-bottom: 5px;">Promedio: <strong style="color: #424242; font-size: 18px;">' + promedio.toFixed(2) + '</strong></div>';
                htmlContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">';
                htmlContent += '<div style="background: #e8f5e9; padding: 8px; border-radius: 4px;">';
                htmlContent += '<div style="font-size: 11px; color: #666;">Aprobados</div>';
                htmlContent += '<strong style="color: #4caf50;">' + aprobados + '/' + total + '</strong>';
                htmlContent += '<div style="font-size: 11px; color: #4caf50;">(' + porcentajeAprobacion + '%)</div>';
                htmlContent += '</div>';
                htmlContent += '<div style="background: #ffebee; padding: 8px; border-radius: 4px;">';
                htmlContent += '<div style="font-size: 11px; color: #666;">Reprobados</div>';
                htmlContent += '<strong style="color: #f44336;">' + reprobados + '/' + total + '</strong>';
                htmlContent += '<div style="font-size: 11px; color: #f44336;">(' + porcentajeReprobacion + '%)</div>';
                htmlContent += '</div>';
                htmlContent += '</div>';
                
                // Distribuci√≥n por desempe√±o
                htmlContent += '<div style="margin: 15px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">';
                htmlContent += '<div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: bold;">Distribuci√≥n por Desempe√±o:</div>';
                htmlContent += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; font-size: 12px;">';
                
                const porcentajeSuperior = (superior / total * 100).toFixed(1);
                const porcentajeAlto = (alto / total * 100).toFixed(1);
                const porcentajeBasico = (basico / total * 100).toFixed(1);
                const porcentajeBajo = (bajo / total * 100).toFixed(1);
                
                htmlContent += '<div><span style="color: #4CAF50;">‚óè Superior:</span> <strong>' + superior + '</strong> (' + porcentajeSuperior + '%)</div>';
                htmlContent += '<div><span style="color: #2196F3;">‚óè Alto:</span> <strong>' + alto + '</strong> (' + porcentajeAlto + '%)</div>';
                htmlContent += '<div><span style="color: #FF9800;">‚óè B√°sico:</span> <strong>' + basico + '</strong> (' + porcentajeBasico + '%)</div>';
                htmlContent += '<div><span style="color: #F44336;">‚óè Bajo:</span> <strong>' + bajo + '</strong> (' + porcentajeBajo + '%)</div>';
                htmlContent += '</div>';
                htmlContent += '</div>';
                
                // Barra de progreso de aprobaci√≥n
                const barColor = parseFloat(porcentajeAprobacion) >= 70 ? '#4CAF50' : 
                                parseFloat(porcentajeAprobacion) >= 50 ? '#FF9800' : '#F44336';
                
                htmlContent += '<div style="margin: 10px 0;">';
                htmlContent += '<div style="background: #e0e0e0; height: 25px; border-radius: 12px; overflow: hidden; position: relative;">';
                htmlContent += '<div style="background: ' + barColor + '; height: 100%; width: ' + porcentajeAprobacion + '%; transition: width 0.3s; display: flex; align-items: center; justify-content: center;">';
                if (parseFloat(porcentajeAprobacion) > 20) {
                    htmlContent += '<span style="color: white; font-size: 12px; font-weight: bold;">' + porcentajeAprobacion + '%</span>';
                }
                htmlContent += '</div>';
                if (parseFloat(porcentajeAprobacion) <= 20) {
                    htmlContent += '<span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; font-weight: bold; color: #666;">' + porcentajeAprobacion + '%</span>';
                }
                htmlContent += '</div>';
                htmlContent += '</div>';
                
                // Top 5 estudiantes
                if (topEstudiantes.length > 0) {
                    htmlContent += '<div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">';
                    htmlContent += '<div style="font-size: 12px; color: #1976d2; margin-bottom: 8px; font-weight: bold;">üèÜ Top 5 Estudiantes:</div>';
                    htmlContent += '<ol style="margin: 0; padding-left: 20px; font-size: 12px;">';
                    topEstudiantes.forEach((est, idx) => {
                        const medalEmoji = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '';
                        htmlContent += '<li style="margin-bottom: 3px; color: #424242;">';
                        htmlContent += medalEmoji + ' <strong>' + est.nombre + '</strong> ';
                        htmlContent += '(' + est.grado + '-' + est.grupo + ') - ';
                        htmlContent += '<span style="color: #1976d2; font-weight: bold;">' + est.nota.toFixed(2) + '</span>';
                        htmlContent += '</li>';
                    });
                    htmlContent += '</ol>';
                    htmlContent += '</div>';
                }
                
                htmlContent += '</div>';
                htmlContent += '</div>';
            });
            
            htmlContent += '</div>';
            
            // Resumen general al final
            const totalGeneral = Object.values(processedData.areasStats).reduce((sum, area) => sum + area.scores.length, 0);
            const totalAprobados = Object.values(processedData.areasStats).reduce((sum, area) => sum + area.aprobados, 0);
            const totalReprobados = Object.values(processedData.areasStats).reduce((sum, area) => sum + area.reprobados, 0);
            const porcentajeGeneralAprobacion = totalGeneral > 0 ? ((totalAprobados / totalGeneral) * 100).toFixed(1) : 0;
            
            htmlContent += '<div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">';
            htmlContent += '<h3 style="margin-bottom: 15px; color: white;">üìä Resumen General de Todas las √Åreas</h3>';
            htmlContent += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">';
            htmlContent += '<div><div style="font-size: 14px; opacity: 0.9;">Total Evaluaciones</div><div style="font-size: 28px; font-weight: bold;">' + totalGeneral + '</div></div>';
            htmlContent += '<div><div style="font-size: 14px; opacity: 0.9;">Total Aprobados</div><div style="font-size: 28px; font-weight: bold;">' + totalAprobados + '</div></div>';
            htmlContent += '<div><div style="font-size: 14px; opacity: 0.9;">Total Reprobados</div><div style="font-size: 28px; font-weight: bold;">' + totalReprobados + '</div></div>';
            htmlContent += '<div><div style="font-size: 14px; opacity: 0.9;">Tasa de Aprobaci√≥n General</div><div style="font-size: 28px; font-weight: bold;">' + porcentajeGeneralAprobacion + '%</div></div>';
            htmlContent += '</div>';
            htmlContent += '</div>';
            
            content.innerHTML = htmlContent;
        }

        function updateTendenciasAlertas() {
            console.log('Actualizando tendencias y alertas...');
            
            const content = document.getElementById('alertasContent');
            if (!content) {
                console.error('No se encontr√≥ el contenedor alertasContent');
                return;
            }
            
            // Verificar si hay datos procesados
            if (!processedData || !studentsData || studentsData.length === 0) {
                content.innerHTML = '<p>No hay datos procesados. Por favor, procese los archivos primero.</p>';
                return;
            }
            
            // Asegurar que todos los estudiantes tengan predicciones
            let estudiantesConPredicciones = 0;
            studentsData.forEach(student => {
                if (!student.predictions) {
                    // Si no tiene predicciones, generarlas ahora
                    let probability = 0;
                    const notaMinima = escalaConfig.notaMinima || 60;
                    
                    if (student.finalScore < notaMinima * 0.5) probability += 40;
                    else if (student.finalScore < notaMinima * 0.75) probability += 30;
                    else if (student.finalScore < notaMinima) probability += 20;
                    
                    if (student.failedAreas >= 3) probability += 30;
                    else if (student.failedAreas >= 2) probability += 20;
                    else if (student.failedAreas >= 1) probability += 10;
                    
                    probability = Math.min(100, Math.max(0, probability));
                    
                    student.predictions = {
                        probability: probability,
                        trend: 0,
                        risk: probability > 70 ? 'ALTO' : probability > 40 ? 'MEDIO' : 'BAJO',
                        tendencia: 'ESTABLE'
                    };
                }
                if (student.predictions) estudiantesConPredicciones++;
            });
            
            console.log('Estudiantes con predicciones:', estudiantesConPredicciones);
            
            // Obtener datos filtrados
            const filtroGrado = document.getElementById('filterGradoAlertas')?.value || '';
            const filtroGrupo = document.getElementById('filterGrupoAlertas')?.value || '';
            const filtroRiesgo = document.getElementById('filterRiesgoAlertas')?.value || '';
            const filtroEstudiante = document.getElementById('filterEstudianteAlertas')?.value || '';
            
            let filteredStudents = studentsData.filter(s => s.predictions);
            
            if (filtroGrado) {
                filteredStudents = filteredStudents.filter(s => s.grado === filtroGrado);
            }
            if (filtroGrupo) {
                filteredStudents = filteredStudents.filter(s => s.grupo === filtroGrupo);
            }
            if (filtroRiesgo) {
                filteredStudents = filteredStudents.filter(s => s.predictions.risk === filtroRiesgo);
            }
            if (filtroEstudiante) {
                filteredStudents = filteredStudents.filter(s => 
                    s.name.toLowerCase().includes(filtroEstudiante.toLowerCase())
                );
            }
            
            const altosRiesgo = filteredStudents.filter(s => s.predictions.risk === 'ALTO');
            const medioRiesgo = filteredStudents.filter(s => s.predictions.risk === 'MEDIO');
            const bajoRiesgo = filteredStudents.filter(s => s.predictions.risk === 'BAJO');
            
            console.log('Riesgo Alto:', altosRiesgo.length, 'Medio:', medioRiesgo.length, 'Bajo:', bajoRiesgo.length);
            
            let htmlContent = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            
            // Cards de resumen
            htmlContent += '<div style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Alto Riesgo</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + altosRiesgo.length + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Riesgo Medio</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + medioRiesgo.length + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Riesgo Bajo</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + bajoRiesgo.length + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '</div>';
            
            // Tabla de estudiantes en riesgo
            htmlContent += '<h3>üö® Estudiantes en Mayor Riesgo</h3>';
            htmlContent += '<div style="overflow-x: auto;">';
            htmlContent += '<table style="width: 100%; border-collapse: collapse; background: white;">';
            htmlContent += '<thead><tr style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white;">';
            htmlContent += '<th style="padding: 12px;">Estudiante</th>';
            htmlContent += '<th style="padding: 12px;">Grupo</th>';
            htmlContent += '<th style="padding: 12px;">Promedio</th>';
            htmlContent += '<th style="padding: 12px;">√Åreas Perdidas</th>';
            htmlContent += '<th style="padding: 12px;">Probabilidad</th>';
            htmlContent += '<th style="padding: 12px;">Riesgo</th>';
            htmlContent += '</tr></thead><tbody>';
            
            // Ordenar por probabilidad
            const sortedStudents = filteredStudents
                .sort((a, b) => b.predictions.probability - a.predictions.probability)
                .slice(0, 50);
            
            if (sortedStudents.length === 0) {
                htmlContent += '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay estudiantes con los filtros aplicados</td></tr>';
            } else {
                sortedStudents.forEach((student, index) => {
                    const bgColor = index % 2 === 0 ? 'background: #f5f5f5;' : '';
                    const riskBg = student.predictions.risk === 'ALTO' ? '#f44336' : 
                                  student.predictions.risk === 'MEDIO' ? '#ff9800' : '#4caf50';
                    
                    htmlContent += '<tr style="border-bottom: 1px solid #eee; ' + bgColor + '">';
                    htmlContent += '<td style="padding: 12px;">' + student.name + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + student.grado + '-' + student.grupo + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + student.finalScore.toFixed(2) + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + student.failedAreas + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;"><strong>' + student.predictions.probability.toFixed(0) + '%</strong></td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">';
                    htmlContent += '<span style="background: ' + riskBg + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">';
                    htmlContent += student.predictions.risk + '</span>';
                    htmlContent += '</td>';
                    htmlContent += '</tr>';
                });
            }
            
            htmlContent += '</tbody></table></div>';
            content.innerHTML = htmlContent;
        }

        function updateAnalisisPerdida() {
            console.log('Actualizando an√°lisis p√©rdida...');
            
            const content = document.getElementById('perdidaContent');
            if (!content) {
                console.error('No se encontr√≥ el contenedor perdidaContent');
                return;
            }
            
            // Verificar si hay datos procesados
            if (!processedData || !studentsData || studentsData.length === 0) {
                content.innerHTML = '<p>No hay datos procesados. Por favor, procese los archivos primero.</p>';
                return;
            }
            
            const areasPerderAno = escalaConfig.areasPerderAno || 3;
            
            // Asegurar que todos los estudiantes tengan los campos necesarios
            studentsData.forEach(student => {
                if (!student.estadoAno) {
                    // Calcular estado si no existe
                    let areasImposibles = 0;
                    let areasCriticas = 0;
                    let areasDificiles = 0;
                    
                    Object.values(student.areas).forEach(area => {
                        if (area.final < escalaConfig.notaMinima * 0.5) areasImposibles++;
                        else if (area.final < escalaConfig.notaMinima * 0.75) areasCriticas++;
                        else if (area.final < escalaConfig.notaMinima) areasDificiles++;
                    });
                    
                    student.areasImposibles = areasImposibles;
                    student.areasCriticas = areasCriticas;
                    student.areasDificiles = areasDificiles;
                    student.totalAreasPerdiendo = areasImposibles + areasCriticas;
                    
                    if (areasImposibles >= areasPerderAno) {
                        student.estadoAno = 'PERDIENDO';
                    } else if (areasImposibles + areasCriticas >= areasPerderAno) {
                        student.estadoAno = 'CRITICO';
                    } else if (areasImposibles + areasCriticas + areasDificiles >= areasPerderAno) {
                        student.estadoAno = 'DIFICIL';
                    } else if (student.failedAreas > 0 && student.failedAreas < areasPerderAno) {
                        student.estadoAno = 'POSIBLE';
                    } else {
                        student.estadoAno = 'APROBANDO';
                    }
                }
            });
            
            // Obtener datos filtrados
            const filtroGrado = document.getElementById('filterGradoPerdida')?.value || '';
            const filtroGrupo = document.getElementById('filterGrupoPerdida')?.value || '';
            const filtroEstado = document.getElementById('filterEstadoPerdida')?.value || '';
            const filtroEstudiante = document.getElementById('filterEstudiantePerdida')?.value || '';
            
            let filtrados = [...studentsData];
            
            if (filtroGrado) {
                filtrados = filtrados.filter(s => s.grado === filtroGrado);
            }
            if (filtroGrupo) {
                filtrados = filtrados.filter(s => s.grupo === filtroGrupo);
            }
            if (filtroEstado) {
                filtrados = filtrados.filter(s => s.estadoAno === filtroEstado);
            }
            if (filtroEstudiante) {
                filtrados = filtrados.filter(s => 
                    s.name.toLowerCase().includes(filtroEstudiante.toLowerCase())
                );
            }
            
            // Calcular estad√≠sticas
            const totalPerdiendo = studentsData.filter(s => s.estadoAno === 'PERDIENDO').length;
            const totalCritico = studentsData.filter(s => s.estadoAno === 'CRITICO').length;
            const totalDificil = studentsData.filter(s => s.estadoAno === 'DIFICIL').length;
            const totalPosible = studentsData.filter(s => s.estadoAno === 'POSIBLE').length;
            const totalAprobando = studentsData.filter(s => s.estadoAno === 'APROBANDO').length;
            
            const porcPerdida = studentsData.length > 0 ? 
                ((totalPerdiendo / studentsData.length) * 100).toFixed(1) : 0;
            
            let htmlContent = '';
            
            // Informaci√≥n de configuraci√≥n
            htmlContent += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            htmlContent += '<strong>Configuraci√≥n:</strong> Un estudiante pierde el a√±o con <strong>' + areasPerderAno + '</strong> o m√°s √°reas perdidas | ';
            htmlContent += 'Escala: ' + escalaConfig.escala + ' | ';
            htmlContent += 'Nota m√≠nima: ' + escalaConfig.notaMinima;
            htmlContent += '</div>';
            
            // Cards de resumen
            htmlContent += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Perdiendo el A√±o</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + totalPerdiendo + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #ff5722 0%, #d84315 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Riesgo Cr√≠tico</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + totalCritico + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #ff9800 0%, #e65100 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Riesgo Dif√≠cil</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + totalDificil + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Riesgo Posible</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + totalPosible + '</div>';
            htmlContent += '</div>';

            htmlContent += '<div style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">Aprobando</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + totalAprobando + '</div>';
            htmlContent += '</div>';
            
            htmlContent += '<div style="background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%); color: white; padding: 20px; border-radius: 8px;">';
            htmlContent += '<div style="font-size: 14px; opacity: 0.9;">% P√©rdida del A√±o</div>';
            htmlContent += '<div style="font-size: 36px; font-weight: bold;">' + porcPerdida + '%</div>';
            htmlContent += '</div>';
            
            htmlContent += '</div>';
            
            // Tabla de estudiantes
            htmlContent += '<h3 style="margin-bottom: 15px;">üìã Listado Detallado de Estudiantes</h3>';
            htmlContent += '<p style="margin-bottom: 10px;">Mostrando ' + filtrados.length + ' de ' + studentsData.length + ' estudiantes</p>';
            htmlContent += '<div style="overflow-x: auto;">';
            htmlContent += '<table style="width: 100%; border-collapse: collapse; background: white;">';
            htmlContent += '<thead><tr style="background: linear-gradient(135deg, #607d8b 0%, #37474f 100%); color: white;">';
            htmlContent += '<th style="padding: 12px;">Estudiante</th>';
            htmlContent += '<th style="padding: 12px;">Curso</th>';
            htmlContent += '<th style="padding: 12px;">Promedio</th>';
            htmlContent += '<th style="padding: 12px;">√Åreas Perdidas</th>';
            htmlContent += '<th style="padding: 12px;">Estado</th>';
            htmlContent += '</tr></thead><tbody>';
            
            if (filtrados.length === 0) {
                htmlContent += '<tr><td colspan="5" style="text-align: center; padding: 20px;">No se encontraron registros con los filtros aplicados</td></tr>';
            } else {
                // Ordenar por estado
                filtrados.sort((a, b) => {
                    const ordenEstado = {'PERDIENDO': 0, 'CRITICO': 1, 'DIFICIL': 2, 'POSIBLE': 3, 'APROBANDO': 4};
                    return ordenEstado[a.estadoAno] - ordenEstado[b.estadoAno];
                });
                
                filtrados.slice(0, 100).forEach((student, index) => {
                    const bgColor = index % 2 === 0 ? 'background: #f5f5f5;' : '';
                    const estadoColor = {
                        'PERDIENDO': '#f44336',
                        'CRITICO': '#ff5722',
                        'DIFICIL': '#ff9800',
                        'POSIBLE': '#2196F3',
                        'APROBANDO': '#4caf50'
                    };
                    
                    htmlContent += '<tr style="border-bottom: 1px solid #eee; ' + bgColor + '">';
                    htmlContent += '<td style="padding: 12px;">' + student.name + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + student.grado + '-' + student.grupo + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + student.finalScore.toFixed(2) + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">' + (student.totalAreasPerdiendo || 0) + '</td>';
                    htmlContent += '<td style="padding: 12px; text-align: center;">';
                    htmlContent += '<span style="background: ' + estadoColor[student.estadoAno] + '; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">';
                    htmlContent += student.estadoAno + '</span>';
                    htmlContent += '</td>';
                    htmlContent += '</tr>';
                });
            }
            
            htmlContent += '</tbody></table></div>';
            
            content.innerHTML = htmlContent;
        }

        // Inicializaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            
            // Configurar manejadores de eventos
            for (let i = 1; i <= 4; i++) {
                const fileInput = document.getElementById('file' + i);
                if (fileInput) {
                    fileInput.addEventListener('change', (function(periodo) {
                        return function(e) {
                            handleFileUpload(e, periodo);
                        };
                    })(i));
                }
            }
            
            // Eventos para pesos
            ['peso1', 'peso2', 'peso3', 'peso4'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateTotalWeight);
                }
            });
            
            updateTotalWeight();
        });

        console.log('Dashboard acad√©mico cargado completamente');
    </script>
</body>
</html>
